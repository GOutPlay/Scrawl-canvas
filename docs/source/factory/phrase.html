<!DOCTYPE html>

<html>
<head>
  <title>Phrase factory</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../worker/filter.html">
                  ./source/worker/filter.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="phrase-factory">Phrase factory</h1>
<p>Phrase entitys are graphical text rectangles rendered onto a DOM &lt;canvas&gt; element using the Canvas API’s <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D">CanvasRenderingContext2D interface</a> - in particular the <code>fillRect</code>, <code>strokeRect</code>, <code>fillText</code> and <code>strokeText</code> methods.</p>
<ul>
<li>Positioning functionality for the Phrase is supplied by the <strong>position</strong> mixin, while rendering functionality comes from the <strong>entity</strong> mixin. </li>
<li>Phrases can use CSS color Strings for their fillStyle and strokeStyle values, alongside <strong>Gradient</strong>, <strong>RadialGradient</strong>, <strong>Color</strong> and <strong>Pattern</strong> objects. </li>
<li>They will also accept <strong>Filter</strong> objects.</li>
<li>They can use <strong>Anchor</strong> objects for user navigation. </li>
<li>They can be rendered to the canvas by including them in a <strong>Cell</strong> object’s <strong>Group</strong>. </li>
<li>They can be <strong>animated</strong> directly, or using delta animation, or act as the target for <strong>Tween</strong> animations.</li>
<li>Phrases can be cloned, and killed.</li>
</ul>
<p>Phrase entity <strong>dimensions</strong> work differently to that of other entitys:</p>
<ul>
<li>The <code>width</code> attribute is required. Phrase entitys will automatically render text longer than its width in multiple lines on the canvas.</li>
<li>The <code>height</code> attribute is normally disregarded. Instead height is calculated as a combination of the font <code>size</code>, <code>lineheight</code>, and the number of lines of text that need to be rendered on the canvas - which itself depends on the text’s length and the entity’s <code>width</code> attribute</li>
</ul>
<p>Phrase entitys use <a href="./fontAttribute.html">FontAttribute objects</a> to help manage their text font:</p>
<ul>
<li>More than one font family can be used in a single Phrase.</li>
<li>Font styles are also supported: a single Phrase can include multiple episodes of <strong>bold</strong>, <em>italic</em>, etc.</li>
<li>More than one font size can be displayed within a Phrase.</li>
<li>Letter spacing is supported, both across the entire text and within the text.</li>
<li>Beyond fonts, ranges of letters within the Phrase text can be background highlighted, or given overlines and/or underlines.</li>
</ul>
<p>Phrase entitys fully support <strong>text along a path</strong> at the Phrase, word and letter levels.</p>
<p>Phrase entity text content is <strong>accessible to assistive technologies</strong> such as screen readers, by default.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h4 id="demos">Demos:</h4>
<ul>
<li><a href="../../demo/canvas-015.html">Canvas-015</a> - Phrase entity (make, clone, method, multiline)</li>
<li><a href="../../demo/canvas-016.html">Canvas-016</a> - Phrase entity position and font attributes; Block mimic functionality</li>
<li><a href="../../demo/canvas-017.html">Canvas-017</a> - Phrase entity - test lineHeight, letterSpacing and justify attributes; setGlyphStyles() functionality</li>
<li><a href="../../demo/canvas-018.html">Canvas-018</a> - Phrase entity - text along a path</li>
<li><a href="../../demo/canvas-019.html">Canvas-019</a> - Artefact collision detection</li>
<li><a href="../../demo/component-001.html">Component-001</a> - Scrawl-canvas DOM element components</li>
<li><a href="../../demo/component-004.html">Component-004</a> - Scrawl-canvas packets - save and load a range of different entitys</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h4 id="imports">Imports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { constructors, cell, cellnames, styles, stylesnames, artefact } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/library.js'</span>;
<span class="hljs-keyword">import</span> { scrawlCanvasHold } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/document.js'</span>;
<span class="hljs-keyword">import</span> { mergeOver, pushUnique, xt, ensurePositiveFloat, ensureFloat, ensureString } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/utilities.js'</span>;

<span class="hljs-keyword">import</span> { requestCell, releaseCell } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cell.js'</span>;

<span class="hljs-keyword">import</span> { makeFontAttributes } <span class="hljs-keyword">from</span> <span class="hljs-string">'./fontAttributes.js'</span>;

<span class="hljs-keyword">import</span> baseMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/base.js'</span>;
<span class="hljs-keyword">import</span> positionMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/position.js'</span>;
<span class="hljs-keyword">import</span> anchorMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/anchor.js'</span>;
<span class="hljs-keyword">import</span> entityMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/entity.js'</span>;
<span class="hljs-keyword">import</span> filterMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/filter.js'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Constants used by Phrase entitys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> fontHeightCalculator = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
fontHeightCalculator.style.padding = <span class="hljs-number">0</span>;
fontHeightCalculator.style.border = <span class="hljs-number">0</span>;
fontHeightCalculator.style.margin = <span class="hljs-number">0</span>;
fontHeightCalculator.style.height = <span class="hljs-string">'auto'</span>;
fontHeightCalculator.style.lineHeight = <span class="hljs-number">1</span>;
fontHeightCalculator.style.boxSizing = <span class="hljs-string">'border-box'</span>;
fontHeightCalculator.innerHTML = <span class="hljs-string">'|/}ÁÅþ§¶¿∑ƒ⌈⌊qwertyd0123456789QWERTY'</span>;
scrawlCanvasHold.appendChild(fontHeightCalculator);

<span class="hljs-keyword">const</span> textEntityConverter = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'textarea'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4 id="phrase-constructor">Phrase constructor</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> Phrase = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes = makeFontAttributes(items);

    <span class="hljs-keyword">delete</span> items.font;
    <span class="hljs-keyword">delete</span> items.style;
    <span class="hljs-keyword">delete</span> items.variant;
    <span class="hljs-keyword">delete</span> items.weight;
    <span class="hljs-keyword">delete</span> items.stretch;
    <span class="hljs-keyword">delete</span> items.size;
    <span class="hljs-keyword">delete</span> items.sizeValue;
    <span class="hljs-keyword">delete</span> items.sizeMetric;
    <span class="hljs-keyword">delete</span> items.family;

    <span class="hljs-keyword">this</span>.entityInit(items);

    <span class="hljs-keyword">this</span>.glyphStyles = [];

    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h4 id="phrase-prototype">Phrase prototype</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> P = Phrase.prototype = <span class="hljs-built_in">Object</span>.create(<span class="hljs-built_in">Object</span>.prototype);
P.type = <span class="hljs-string">'Phrase'</span>;
P.lib = <span class="hljs-string">'entity'</span>;
P.isArtefact = <span class="hljs-literal">true</span>;
P.isAsset = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h4 id="mixins">Mixins</h4>
<ul>
<li><a href="../mixin/base.html">base</a></li>
<li><a href="../mixin/position.html">position</a></li>
<li><a href="../mixin/anchor.html">anchor</a></li>
<li><a href="../mixin/entity.html">entity</a></li>
<li><a href="../mixin/filter.html">filter</a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P = baseMix(P);
P = positionMix(P);
P = anchorMix(P);
P = entityMix(P);
P = filterMix(P);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h4 id="phrase-attributes">Phrase attributes</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong>text</strong> - the text String to be displayed by the Phrase</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    text: <span class="hljs-string">''</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><strong>exposeText</strong> - Boolean accessibility feature</p>
<ul>
<li>When <strong>exposeText</strong> is set to true (default), Scrawl-canvas will create an element in the DOM and mirror its current text value in that element. </li>
<li>The element - a &lt;div&gt; - is attached to the canvas element’s textHold element, which immediately follows that element and has zero dimensions, so its contents don’t interfere with the flow of the rest of the DOM content.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    exposeText: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong>lineHeight</strong> - a positive float Number multiplier applied to the font height to add space between lines of text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    lineHeight: <span class="hljs-number">1.5</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><strong>letterSpacing</strong> - a positive float Number representing a set number of pixels to place between each glyph (letter). Can be overridden for letter ranges using styling objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    letterSpacing: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><strong>justify</strong> - String value to indicate how the text should justify itself within its dimensions box.</p>
<ul>
<li>Permitted values are: <code>left</code> (default), <code>center</code>, <code>right</code>, <code>full</code> (for ‘justified’ text).</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    justify: <span class="hljs-string">'left'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h5 id="in-text-styling">In-text styling</h5>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><strong>glyphStyles</strong> - Array of styling objects</p>
<p>Glyphs (letters) can be individually styled by adding a <strong><em>styling object</em></strong> to the <code>glyphStyles</code> Array. Subsequent glyphs will inherit those styles until a second styling object is encountered further along the array.</p>
<p>Subsequent styling objects will alter specified attributes, leaving other attributes in their current (not default) state. To reset all attributes to their defaults and at the same time change selected attributes, include <code>defaults: true</code> in the object.</p>
<p>The styling object can take one or more of the following attributes:</p>
<ul>
<li><code>style</code> - eg ‘italic’</li>
<li><code>variant</code> - eg ‘small-caps’</li>
<li><code>weight</code> - eg ‘bold’</li>
<li><code>stretch</code></li>
<li><code>size</code> - any permitted font size value</li>
<li><code>family</code> </li>
<li><code>space</code> - alter the letterSpacing values to spread or condense glyphs</li>
<li><code>fill</code> - fillStyle to be applied to the glyph</li>
<li><code>stroke</code> - strokeStyle to be applied to the glyph</li>
<li><code>highlight</code> - boolean - whether highlight should be applied to the glyph</li>
<li><code>underline</code> - boolean - whether underline should be applied to the glyph</li>
<li><code>overline</code> - boolean - whether overline should be applied to the glyph</li>
<li><code>defaults</code> - boolean - setting this to true will set the glyph (and subsequent glyphs) to the Phrase entity’s current font and fill/stroke style values</li>
</ul>
<pre><code><span class="hljs-comment">// Example: "make the word glyphs bold"</span>
myPhrase.setGlyphStyles({<span class="hljs-attr">weight</span>: <span class="hljs-string">'bold'</span>}, <span class="hljs-number">14</span>);
myPhrase.setGlyphStyles({<span class="hljs-attr">defaults</span>: <span class="hljs-literal">true</span>}, <span class="hljs-number">20</span>);</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>    glyphStyles: [],</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h5 id="overlines-underlines-highlighting">Overlines, underlines, highlighting</h5>
<p>We set the position and style for overlines, underlines and background highlight on a per-Phrase entity level, then apply them to glyph ranges using <code>glyphStyles</code> styling objects.</p>
<ul>
<li>over/underline decoration positions are float Numbers (generally) in the range <code>0 - 1</code> which represent where on the Phrase text line the decoration should appear. The values are relative to line heights, which in turn depend on font size and Phrase lineHeight attributes.</li>
<li>over/underline decoration style values, and the highlight style value, can be any valid CSS color String.</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><strong>overlinePosition</strong>, <strong>overlineStyle</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    overlinePosition: <span class="hljs-number">0.1</span>,
    <span class="hljs-attr">overlineStyle</span>: <span class="hljs-string">'rgb(250,0,0)'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p><strong>underlinePosition</strong>, <strong>underlineStyle</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    underlinePosition: <span class="hljs-number">0.6</span>,
    <span class="hljs-attr">underlineStyle</span>: <span class="hljs-string">'rgb(250,0,0)'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><strong>highlightStyle</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    highlightStyle: <span class="hljs-string">'rgba(250,218,94,0.4)'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h5 id="bounding-box">Bounding box</h5>
<p>The bounding box represents the Phrase entity’s collision detection <strong><em>hit area</em></strong>. It contains all of the entity’s text, including line spacing.</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p><strong>boundingBoxColor</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    boundingBoxColor: <span class="hljs-string">'rgba(0,0,0,0.5)'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><strong>showBoundingBox</strong> - Boolean flag indicating whether the Phrase entity’s bounding box should be displayed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    showBoundingBox: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h5 id="text-along-a-path">Text along a path</h5>
<p>Phrase entitys, alongside other artefacts, can use a <a href="./shape.html">Shape entity</a> as a <strong><em>reference path</em></strong> to determine its location in the canvas display - achieved by setting the <code>path</code>, <code>pathPosition</code>, etc attributes as required.</p>
<ul>
<li>In this case, the Phrase’s text will appear as boxed text, with straight lines of text.</li>
</ul>
<p>We have an additional use case for Phrase text: to <strong><em>map each letter along the length of a Shape entity’s path</em></strong>. For this, we have specific <code>textPath</code>, <code>textPathPosition</code>, etc attributes.</p>

            </div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><strong>textPath</strong> - Shape entity to be used as the text path; can be supplied either as the entity object itself, or as the entity’s name-String.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    textPath: <span class="hljs-string">''</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><strong>textPathPosition</strong> - float Number value between <code>0.0 - 1.0</code> representing the text’s first character’s position on the path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    textPathPosition: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><strong>textPathLoop</strong> - Boolean flag - when true (default) the first character’s position will loop back to <code>0</code> when it passes <code>1</code> (and vice versa).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    textPathLoop: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><strong>addTextPathRoll</strong> - Boolean flag - when true (default) each glyph in the text will rotate to match its position’s tangent on the path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    addTextPathRoll: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><strong>textPathDirection</strong> - String with values <code>ltr</code> or <code>rtl</code> - affects how the text glyphs will arrange themselves along the path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    textPathDirection: <span class="hljs-string">'ltr'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><strong>treatWordAsGlyph</strong> - Boolean flag - when true, Scrawl-canvas will treat each word in the text as if it was a glyph/letter; default: false.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    treatWordAsGlyph: <span class="hljs-literal">false</span>,
};
P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h4 id="packet-management">Packet management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.packetExclusions = pushUnique(P.packetExclusions, [<span class="hljs-string">'textPositions'</span>, <span class="hljs-string">'textLines'</span>, <span class="hljs-string">'textLineWidths'</span>, <span class="hljs-string">'textLineWords'</span>, <span class="hljs-string">'textGlyphs'</span>, <span class="hljs-string">'textGlyphWidths'</span>, <span class="hljs-string">'fontAttributes'</span>]);

P.finalizePacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">copy, items</span>) </span>{

    <span class="hljs-keyword">let</span> stateCopy = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.state.saveAsPacket(items))[<span class="hljs-number">3</span>];
    copy = mergeOver(copy, stateCopy);

    <span class="hljs-keyword">let</span> fontAttributesCopy = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.fontAttributes.saveAsPacket(items))[<span class="hljs-number">3</span>];
    <span class="hljs-keyword">delete</span> fontAttributesCopy.name;
    copy = mergeOver(copy, fontAttributesCopy);

    copy = <span class="hljs-keyword">this</span>.handlePacketAnchor(copy, items);

    <span class="hljs-keyword">return</span> copy;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h4 id="clone-management">Clone management</h4>
<p>No additional clone functionality required</p>

            </div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h4 id="kill-management">Kill management</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.factoryKill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.exposedTextHold) <span class="hljs-keyword">this</span>.exposedTextHold.remove();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h4 id="get-set-deltaset">Get, Set, deltaSet</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> G = P.getters,
    S = P.setters,
    D = P.deltaSetters;</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p><strong>handle</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.handleX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

    <span class="hljs-keyword">if</span> (coord != <span class="hljs-literal">null</span>) {

        <span class="hljs-keyword">this</span>.handle[<span class="hljs-number">0</span>] = coord;
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    }
};
S.handleY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

    <span class="hljs-keyword">if</span> (coord != <span class="hljs-literal">null</span>) {

        <span class="hljs-keyword">this</span>.handle[<span class="hljs-number">1</span>] = coord;
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    }
};
S.handle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) </span>{

    <span class="hljs-keyword">this</span>.setCoordinateHelper(<span class="hljs-string">'handle'</span>, x, y);
    <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};
D.handleX = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

    <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.handle;
    c[<span class="hljs-number">0</span>] = addStrings(c[<span class="hljs-number">0</span>], coord);
    <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};
D.handleY = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">coord</span>) </span>{

    <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.handle;
    c[<span class="hljs-number">1</span>] = addStrings(c[<span class="hljs-number">1</span>], coord);
    <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};
D.handle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">x, y</span>) </span>{

    <span class="hljs-keyword">this</span>.setDeltaCoordinateHelper(<span class="hljs-string">'handle'</span>, x, y);
    <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><strong>text</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.text = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.text = ensureString(item);
    
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><strong>justify</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.permittedJustifications = [<span class="hljs-string">'left'</span>, <span class="hljs-string">'right'</span>, <span class="hljs-string">'center'</span>, <span class="hljs-string">'full'</span>];
S.justify = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.permittedJustifications.indexOf(item) &gt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">this</span>.justify = item;
    
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p><strong>width</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.width = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.dimensions[<span class="hljs-number">0</span>] = item;

    <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};
D.width = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">this</span>.dimensions;
    c[<span class="hljs-number">0</span>] = addStrings(c[<span class="hljs-number">0</span>], item);

    <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p><strong>scale</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.scale = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.scale = item;

    <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyScale = <span class="hljs-literal">true</span>;
};
D.scale = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.scale += item;

    <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyScale = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p><strong>lineHeight</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.lineHeight = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.lineHeight = ensurePositiveFloat(item, <span class="hljs-number">3</span>);

    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};
D.lineHeight = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.lineHeight += ensureFloat(item, <span class="hljs-number">3</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.lineHeight &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">this</span>.lineHeight = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><strong>letterSpacing</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.letterSpacing = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.letterSpacing = ensurePositiveFloat(item, <span class="hljs-number">3</span>);

    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};
D.letterSpacing = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.letterSpacing += ensureFloat(item, <span class="hljs-number">3</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.letterSpacing &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">this</span>.letterSpacing = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p><strong>overlinePosition</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.overlinePosition = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.overlinePosition = ensureFloat(item, <span class="hljs-number">3</span>);

    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};
D.overlinePosition = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.overlinePosition += ensureFloat(item, <span class="hljs-number">3</span>);

    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><strong>underlinePosition</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.underlinePosition = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.underlinePosition = ensureFloat(item, <span class="hljs-number">3</span>);

    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};
D.underlinePosition = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.underlinePosition += ensureFloat(item, <span class="hljs-number">3</span>);

    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p><strong>textPath</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.textPath = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.textPath = item;

    <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p><strong>textPathPosition</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.textPathPosition = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.textPathLoop) {

        item = <span class="hljs-built_in">Math</span>.abs(item);
        <span class="hljs-keyword">this</span>.textPathPosition = item - <span class="hljs-built_in">Math</span>.floor(item);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.textPathPosition = item;
};
D.textPathPosition = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> newVal = <span class="hljs-keyword">this</span>.textPathPosition + item;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.textPathLoop) {

        newVal = <span class="hljs-built_in">Math</span>.abs(newVal);
        <span class="hljs-keyword">this</span>.textPathPosition = newVal - <span class="hljs-built_in">Math</span>.floor(newVal);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.textPathPosition = newVal;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <h5 id="fontattribute-attributes">FontAttribute attributes</h5>
<p>Phrase entitys break down fonts into their constituent parts using <a href="./fontAttribute.html">FontAttribute</a> objects.</p>
<ul>
<li>The Canvas API standards for using fonts on a canvas (<code>font</code>, <code>textAlign</code>, <code>textBaseline</code>) are near-useless, and often lead to a sub-par display of text. </li>
<li>Thus Phrase entitys hide these from the developer, instead giving them functions to get/set/update fonts which align more closely with CSS standards.</li>
<li>Note that the Canvas API only supports a subset of possible CSS font-related values, and that the level of support for even these will vary between browsers/devices. The Phrase entity will do work to ensure the font strings passed to the Canvas API CanvasRenderingContext2D engine will be valid (thus avoiding unnecessary runtime errors), but this may not be the same as a developer specifies in their code.</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p><strong>font</strong> - the desired CSS font (<code>get</code> returns the actual font String being used)</p>
<ul>
<li>The font String is not retained. Rather we break it down into its constituent parts, and rebuild the font String when needed.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.font = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fontAttributes.get(<span class="hljs-string">'font'</span>);
};
S.font = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes.set({<span class="hljs-attr">font</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p><strong>style</strong> - CSS <code>font-style</code> String - <code>normal</code>, <code>italic</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.style = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fontAttributes.get(<span class="hljs-string">'style'</span>);
};
S.style = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes.set({<span class="hljs-attr">style</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p><strong>variant</strong> - CSS <code>font-variant</code> String - <code>normal</code>, <code>small-caps</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.variant = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fontAttributes.get(<span class="hljs-string">'variant'</span>);
};
S.variant = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes.set({<span class="hljs-attr">variant</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><strong>weight</strong> - CSS <code>font-weight</code> String - <code>normal</code>, <code>bold</code>, <code>lighter</code>, <code>bolder</code>, or an integer Number (between <code>1</code> and <code>1000</code>)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.weight = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fontAttributes.get(<span class="hljs-string">'weight'</span>);
};
S.weight = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes.set({<span class="hljs-attr">weight</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p><strong>stretch</strong> - CSS <code>font-stretch</code> String - <code>normal</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.stretch = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fontAttributes.get(<span class="hljs-string">'stretch'</span>);
};
S.stretch = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes.set({<span class="hljs-attr">stretch</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p><strong>size</strong> - CSS <code>font-size</code> String:</p>
<ul>
<li><code>xx-small</code>, <code>x-small</code>, <code>small</code>, <code>medium</code>, <code>large</code>, <code>x-large</code>, <code>xx-large</code> </li>
<li><code>smaller</code>, <code>larger</code></li>
<li><code>120%</code></li>
<li><code>1.2rem</code>, <code>12px</code>, etc - Scrawl-canvas will work with the following metrics: <code>em</code>, <code>ch</code>, <code>ex</code>, <code>rem</code>, <code>vh</code>, <code>vw</code>, <code>vmin</code>, <code>vmax</code>, <code>px</code>, <code>cm</code>, <code>mm</code>, <code>in</code>, <code>pc</code>, <code>pt</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.size = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fontAttributes.get(<span class="hljs-string">'size'</span>);
};
S.size = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes.set({<span class="hljs-attr">size</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><strong>sizeValue</strong> - the Number part of the font’s size value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.sizeValue = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fontAttributes.get(<span class="hljs-string">'sizeValue'</span>);
};
S.sizeValue = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes.set({<span class="hljs-attr">sizeValue</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};
D.sizeValue = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes.deltaSet({<span class="hljs-attr">sizeValue</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><strong>sizeMetric</strong> - the String metric part of the font’s size value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.sizeMetric = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fontAttributes.get(<span class="hljs-string">'sizeMetric'</span>);
};
S.sizeMetric = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.fontAttributes.set({<span class="hljs-attr">sizeMetric</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p><strong>family</strong> - CSS <code>font-family</code> String</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.family = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fontAttributes.get(<span class="hljs-string">'family'</span>);
};
S.family = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{
    
    <span class="hljs-keyword">this</span>.fontAttributes.set({<span class="hljs-attr">family</span>: item});

    <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <h4 id="prototype-functions">Prototype functions</h4>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p><code>setGlyphStyles</code>
We have more control over the <code>glyphStyles</code> array if we use this dedicated function to manage them. Requires two (or more) arguments:</p>
<ul>
<li>First argument - object containing one or more <code>key: value</code> attributes - permitted keys are: <code>style</code>, <code>variant</code>, <code>weight</code>, <code>stretch</code>, <code>size</code>, <code>family</code>, <code>space</code>, <code>fill</code>, <code>stroke</code>, <code>highlight</code>, <code>underline</code>, <code>overline</code>, <code>defaults</code></li>
<li>Second argument - Array of positive integer Numbers representing the index at which point the style will be applied to the text String</li>
<li>Alternatively the second and subsequent arguments can be positive integer Numbers, serving the same purpose</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.setGlyphStyles = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args, ...pos</span>) </span>{

    <span class="hljs-keyword">if</span> (args &amp;&amp; <span class="hljs-built_in">Array</span>.isArray(pos)) {

        <span class="hljs-keyword">let</span> styles = <span class="hljs-keyword">this</span>.glyphStyles,
            slot, style, i, iz;

        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = pos.length; i &lt; iz; i++) {

            slot = pos[i];
            style = styles[slot];

            <span class="hljs-keyword">if</span> (!style) styles[slot] = args;
            <span class="hljs-keyword">else</span> mergeOver(style, args);
        }

        <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p><code>getTextPath</code> - internal function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.getTextPath = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> path = <span class="hljs-keyword">this</span>.textPath;

    <span class="hljs-keyword">if</span> (path &amp;&amp; path.substring) {

        path = <span class="hljs-keyword">this</span>.textPath = artefact[<span class="hljs-keyword">this</span>.textPath];

        <span class="hljs-keyword">if</span> (path.type === <span class="hljs-string">'Shape'</span> &amp;&amp; path.useAsPath) path.pathed.push(<span class="hljs-keyword">this</span>.name);
        <span class="hljs-keyword">else</span> {

            path = <span class="hljs-keyword">this</span>.path = <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-keyword">return</span> path;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <h4 id="display-cycle-functionality">Display cycle functionality</h4>
<p>Phrase entitys, because they handle graphical text which has its own special requirements and methods in the Canvas API, has to overwrite a substantial portion of the Display cycle functionality defined in the entity mixin.</p>

            </div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p><code>cleanPathObject</code> - overwrites mixin/entity.js functionality so that it can deal with the <code>dirtyFont</code>, <code>dirtyText</code> and <code>dirtyHandle</code> flags </p>
<ul>
<li>Fonts don’t have accessible paths; Phrase entity pathObjects represent the bounding box around the entity’s text.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.cleanPathObject = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.noPathUpdates || !<span class="hljs-keyword">this</span>.pathObject) {
        
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyFont &amp;&amp; <span class="hljs-keyword">this</span>.fontAttributes) {

            <span class="hljs-keyword">this</span>.dirtyFont = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.fontAttributes.buildFont(<span class="hljs-keyword">this</span>.scale);
            <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyText) <span class="hljs-keyword">this</span>.buildText();

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyHandle) <span class="hljs-keyword">this</span>.cleanHandle();

        <span class="hljs-keyword">let</span> p = <span class="hljs-keyword">this</span>.pathObject = <span class="hljs-keyword">new</span> Path2D();
        
        <span class="hljs-keyword">let</span> handle = <span class="hljs-keyword">this</span>.currentHandle,
            dims = <span class="hljs-keyword">this</span>.currentDimensions,
            scale = <span class="hljs-keyword">this</span>.currentScale,
            x = -handle[<span class="hljs-number">0</span>] * scale,
            y = -handle[<span class="hljs-number">1</span>] * scale,
            w = dims[<span class="hljs-number">0</span>] * scale,
            h = dims[<span class="hljs-number">1</span>] * scale;

        p.rect(x, y, w, h);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p><code>buildText</code> - internal function called by <code>cleanPathObject</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.buildText = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">this</span>.dirtyText = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.text = <span class="hljs-keyword">this</span>.convertTextEntityCharacters(<span class="hljs-keyword">this</span>.text);
    <span class="hljs-keyword">this</span>.calculateTextPositions(<span class="hljs-keyword">this</span>.text);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.exposeText) {

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.exposedTextHold) {

            <span class="hljs-keyword">let</span> myhold = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'div'</span>);
            myhold.id = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.name}</span>-text-hold`</span>;
            <span class="hljs-keyword">this</span>.exposedTextHold = myhold;
            <span class="hljs-keyword">this</span>.exposedTextHoldAttached = <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">this</span>.exposedTextHold.textContent = <span class="hljs-keyword">this</span>.text;

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.exposedTextHoldAttached) {

            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.currentHost &amp;&amp; <span class="hljs-keyword">this</span>.currentHost.controller &amp;&amp; <span class="hljs-keyword">this</span>.currentHost.controller.textHold) {

                <span class="hljs-keyword">this</span>.currentHost.controller.textHold.appendChild(<span class="hljs-keyword">this</span>.exposedTextHold);
                <span class="hljs-keyword">this</span>.exposedTextHoldAttached = <span class="hljs-literal">true</span>;
            }
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p><code>convertTextEntityCharacters</code> - internal function called by <code>buildText</code></p>
<ul>
<li>To convert any HTML entity (eg: &lt; &epsilon;) in the text string into their required glyphs</li>
<li>Also removes excessive white space</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.convertTextEntityCharacters = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> mytext = item.trim();

    mytext = mytext.replace(<span class="hljs-regexp">/[\s\uFEFF\xA0]+/g</span>, <span class="hljs-string">' '</span>);

    textEntityConverter.innerHTML = mytext;
    <span class="hljs-keyword">return</span> textEntityConverter.value;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p><code>calculateTextPositions</code> - internal function called by <code>buildText</code></p>
<ul>
<li>If you are not a fan of big, complex functions … look away now!</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.calculateTextPositions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">mytext</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <ol start="0">
<li><code>strokeStyle</code> and <code>fillStyle</code> helper function</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> makeStyle = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">if</span> (item.substring) {

            <span class="hljs-keyword">let</span> brokenStyle = <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (stylesnames.indexOf(item) &gt;= <span class="hljs-number">0</span>) brokenStyle = styles[item];
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cellnames.indexOf(item) &gt;= <span class="hljs-number">0</span>) brokenStyle = cell[item];

            <span class="hljs-keyword">if</span> (brokenStyle) <span class="hljs-keyword">return</span> brokenStyle.getData(self, host, <span class="hljs-literal">true</span>);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> item;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> item.getData(self, host, <span class="hljs-literal">true</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <ol>
<li>Setup - get values for text? arrays, current?, highlight?, ?Attributes, etc</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> myCell = requestCell(),
        engine = myCell.engine;

    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>,
        host = (<span class="hljs-keyword">this</span>.group &amp;&amp; <span class="hljs-keyword">this</span>.group.getHost) ? <span class="hljs-keyword">this</span>.group.getHost() : myCell;

    <span class="hljs-keyword">let</span> textGlyphs, 
        textGlyphWidths = [], 
        textLines = [], 
        textLineWidths = [],
        textLineWords = [], 
        textPositions = [],
        spacesArray = [],
        gStyle, gPos, item, 
        starts, ends, cursor, word, height,
        space, i, iz, j, jz, k, kz;

    <span class="hljs-keyword">let</span> fragment, len, glyphArr, glyph, nextGlyph, glyphWidth, lineLen, totalLen,
        singles = [],
        pairs = [],
        path = <span class="hljs-keyword">this</span>.getTextPath(),
        direction, loop, rotate;

    <span class="hljs-keyword">let</span> fontAttributes = <span class="hljs-keyword">this</span>.fontAttributes,
        glyphAttributes = fontAttributes.clone({});

    <span class="hljs-keyword">let</span> glyphStyles = <span class="hljs-keyword">this</span>.glyphStyles;

    <span class="hljs-keyword">let</span> state = <span class="hljs-keyword">this</span>.state,
        fontLibrary = {},
        fontArray = [];

    <span class="hljs-keyword">let</span> scale = <span class="hljs-keyword">this</span>.currentScale,
        dims = <span class="hljs-keyword">this</span>.currentDimensions,
        width = dims[<span class="hljs-number">0</span>] * scale,
        treatWordAsGlyph = <span class="hljs-keyword">this</span>.treatWordAsGlyph,
        lineHeight = <span class="hljs-keyword">this</span>.lineHeight,
        justify = <span class="hljs-keyword">this</span>.justify,
        handle, handleX, handleY;

    <span class="hljs-keyword">let</span> defaultFont = fontAttributes.update(scale), 
        defaultFillStyle = makeStyle(state.fillStyle), 
        defaultStrokeStyle = makeStyle(state.strokeStyle), 
        defaultSpace = <span class="hljs-keyword">this</span>.letterSpacing * scale, 

        currentFont = defaultFont, 
        currentFillStyle = defaultFillStyle, 
        currentStrokeStyle = defaultStrokeStyle, 
        currentSpace = defaultSpace;

    <span class="hljs-keyword">let</span> highlightStyle = (<span class="hljs-keyword">this</span>.highlightStyle) ? makeStyle(<span class="hljs-keyword">this</span>.highlightStyle) : <span class="hljs-literal">false</span>,
        highlightFlag = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> underlineStyle = (<span class="hljs-keyword">this</span>.underlineStyle) ? makeStyle(<span class="hljs-keyword">this</span>.underlineStyle) : <span class="hljs-literal">false</span>,
        underlinePosition = <span class="hljs-keyword">this</span>.underlinePosition,
        underlineFlag = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> overlineStyle = (<span class="hljs-keyword">this</span>.overlineStyle) ? makeStyle(<span class="hljs-keyword">this</span>.overlineStyle) : <span class="hljs-literal">false</span>,
        overlinePosition = <span class="hljs-keyword">this</span>.overlinePosition,
        overlineFlag = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> maxHeight = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <ol start="2">
<li>Create <code>textGlyphs</code> array</li>
</ol>
<ul>
<li>also shove the default font into the <code>fontLibrary</code> array</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    textGlyphs = (treatWordAsGlyph) ? <span class="hljs-keyword">this</span>.text.split(<span class="hljs-string">' '</span>) : <span class="hljs-keyword">this</span>.text.split(<span class="hljs-string">''</span>);
    fontArray.push(currentFont);</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <ol start="3">
<li><code>textPositions</code> array will include an array of data for each glyph</li>
</ol>
<ul>
<li><code>[font, strokeStyle, fillStyle, highlight, underline, overline, text, startX, startY, (pathData)]</code></li>
<li>and populate <code>spacesArray</code> with space position data (for full justify calculations later)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = textGlyphs.length; i &lt; iz; i++) {

        item = textGlyphs[i];

        textPositions[i] = [, , , , , , item, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>];

        <span class="hljs-keyword">if</span> (item === <span class="hljs-string">' '</span>) spacesArray.push(i);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <ol start="4">
<li>Process the <code>glyphStyles</code> array to start populating the <code>textPositions</code> arrays</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!glyphStyles[<span class="hljs-number">0</span>]) glyphStyles[<span class="hljs-number">0</span>] = {
        <span class="hljs-attr">family</span>: glyphAttributes.family,
        <span class="hljs-attr">size</span>: (glyphAttributes.sizeValue) ? <span class="hljs-string">`<span class="hljs-subst">${glyphAttributes.sizeValue}</span><span class="hljs-subst">${glyphAttributes.sizeMetric}</span>`</span> : glyphAttributes.sizeMetric,
        <span class="hljs-attr">stretch</span>: glyphAttributes.stretch,
        <span class="hljs-attr">style</span>: glyphAttributes.style,
        <span class="hljs-attr">variant</span>: glyphAttributes.variant,
        <span class="hljs-attr">weight</span>: glyphAttributes.weight,
    };

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = glyphStyles.length; i &lt; iz; i++) {

        gStyle = glyphStyles[i];

        <span class="hljs-keyword">if</span> (gStyle) {

            gPos = textPositions[i];

            <span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) {
                gPos[<span class="hljs-number">0</span>] = currentFont;
                gPos[<span class="hljs-number">1</span>] = currentStrokeStyle;
                gPos[<span class="hljs-number">2</span>] = currentFillStyle;
                gPos[<span class="hljs-number">3</span>] = highlightFlag;
                gPos[<span class="hljs-number">4</span>] = underlineFlag;
                gPos[<span class="hljs-number">5</span>] = overlineFlag;
            }

            <span class="hljs-keyword">if</span> (gStyle.defaults) {
                currentFont = glyphAttributes.update(scale, fontAttributes);
                currentStrokeStyle = defaultStrokeStyle;
                currentFillStyle = defaultFillStyle;
                currentSpace = defaultSpace;
                gPos[<span class="hljs-number">0</span>] = currentFont;
                gPos[<span class="hljs-number">1</span>] = currentStrokeStyle;
                gPos[<span class="hljs-number">2</span>] = currentFillStyle;
                gPos[<span class="hljs-number">3</span>] = highlightFlag;
                gPos[<span class="hljs-number">4</span>] = underlineFlag;
                gPos[<span class="hljs-number">5</span>] = overlineFlag;
            }

            item = gStyle.stroke;
            <span class="hljs-keyword">if</span> (item &amp;&amp; item !== currentStrokeStyle) {

                currentStrokeStyle = makeStyle(gStyle.stroke);
                gPos[<span class="hljs-number">1</span>] = currentStrokeStyle;
            };

            item = gStyle.fill;
            <span class="hljs-keyword">if</span> (item &amp;&amp; item !== currentFillStyle) {

                currentFillStyle = makeStyle(gStyle.fill);
                gPos[<span class="hljs-number">2</span>] = currentFillStyle;
            };

            item = gStyle.space;
            <span class="hljs-keyword">if</span> (xt(item) &amp;&amp; item !== currentSpace) currentSpace = item * scale

            item = gStyle.highlight;
            <span class="hljs-keyword">if</span> (xt(item) &amp;&amp; item !== highlightFlag) {

                highlightFlag = item;
                gPos[<span class="hljs-number">3</span>] = highlightFlag;
            };

            item = gStyle.underline;
            <span class="hljs-keyword">if</span> (xt(item) &amp;&amp; item !== underlineFlag) {

                underlineFlag = item;
                gPos[<span class="hljs-number">4</span>] = underlineFlag;
            };

            item = gStyle.overline;
            <span class="hljs-keyword">if</span> (xt(item) &amp;&amp; item !== overlineFlag) {

                overlineFlag = item;
                gPos[<span class="hljs-number">5</span>] = overlineFlag;
            };

            <span class="hljs-keyword">if</span> (i !== <span class="hljs-number">0</span> &amp;&amp; (gStyle.variant || gStyle.weight || gStyle.style || gStyle.stretch || gStyle.size || gStyle.sizeValue || gStyle.sizeMetric || gStyle.family || gStyle.font)) {

                item = glyphAttributes.update(scale, gStyle);
                <span class="hljs-keyword">if</span> (item !== currentFont) {

                    currentFont = item;
                    gPos[<span class="hljs-number">0</span>] = currentFont;

                    <span class="hljs-keyword">if</span> (fontArray.indexOf(currentFont) &lt; <span class="hljs-number">0</span>) fontArray.push(currentFont);
                }
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Setup <code>textGlyphWidths</code> array, populating it with current letterSpacing values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        textGlyphWidths[i] = currentSpace;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Finish populating <code>textGlyphWidths</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = textGlyphs.length; i &lt; iz; i++) {

        <span class="hljs-keyword">if</span> (xt(textGlyphWidths[i])) currentSpace = textGlyphWidths[i];

        textGlyphWidths[i] = currentSpace;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <ol start="5">
<li>Calculate the text <code>height</code> value</li>
</ol>
<ul>
<li>All lines in a multiline Phrase will use the maximum text height value, even if they don’t include the biggest value</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fontArray.forEach(<span class="hljs-function"><span class="hljs-params">font</span> =&gt;</span> {

        fontHeightCalculator.style.font = font;
        item = fontHeightCalculator.clientHeight;
        fontLibrary[font] = item;
    });

    maxHeight = <span class="hljs-built_in">Math</span>.max(...Object.values(fontLibrary));</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <ol start="6">
<li>Calculate glyph <code>width</code> values</li>
</ol>
<ul>
<li>This is the tricky bit as, ideally, we need to take into account font kerning values</li>
<li>However kerning values go out of the window when font attributes (especially size) change in mid-text</li>
<li>And we need to remember that <code>letterSpacing</code> can also be different in different parts of the text</li>
<li>This is also the best place to populate the <code>textLine</code> arrays</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    totalLen = lineLen = starts = ends = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = textPositions.length; i &lt; iz; i++) {

        glyphArr = textPositions[i];
        glyph = glyphArr[<span class="hljs-number">6</span>];

        <span class="hljs-keyword">if</span> (glyphArr[<span class="hljs-number">0</span>]) engine.font = glyphArr[<span class="hljs-number">0</span>];

        singles.push(engine.measureText(glyph).width);
        
        nextGlyph = textPositions[i + <span class="hljs-number">1</span>];
        nextGlyph = (!treatWordAsGlyph &amp;&amp; nextGlyph) ? nextGlyph[<span class="hljs-number">6</span>] : <span class="hljs-literal">false</span>;

        len = (nextGlyph) ? engine.measureText(<span class="hljs-string">`<span class="hljs-subst">${glyph}</span><span class="hljs-subst">${nextGlyph}</span>`</span>).width : <span class="hljs-literal">false</span>;
        pairs.push(len);
    }

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = pairs.length; i &lt; iz; i++) {

        glyph = pairs[i];

        <span class="hljs-keyword">if</span> (glyph) {

            len = singles[i] + singles[i + <span class="hljs-number">1</span>];
            gPos = textPositions[i + <span class="hljs-number">1</span>];

            <span class="hljs-keyword">if</span> (len &gt; glyph &amp;&amp; !gPos[<span class="hljs-number">0</span>]) singles[i] -= (len - glyph);
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Calculate text line arrays</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = textPositions.length; i &lt; iz; i++) {

        glyphArr = textPositions[i];
        glyph = glyphArr[<span class="hljs-number">6</span>];

        glyphWidth = singles[i] + textGlyphWidths[i];
        textGlyphWidths[i] = glyphWidth;

        <span class="hljs-keyword">if</span> (treatWordAsGlyph || glyph === <span class="hljs-string">' '</span>) ends = i;

        lineLen += glyphWidth;
        totalLen += glyphWidth;</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Need <code>starts</code> to be less than <code>ends</code></p>
<ul>
<li>This should make sure we pick up individual words that are longer than the Phrase entity’s width</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (lineLen &gt;= width &amp;&amp; starts &lt; ends) {

            fragment = textGlyphs.slice(starts, ends).join(<span class="hljs-string">''</span>);
            textLines.push(fragment);
            len = (treatWordAsGlyph) ? fragment.split(<span class="hljs-string">' '</span>).length - <span class="hljs-number">1</span> : fragment.split(<span class="hljs-string">' '</span>).length;
            textLineWords.push(len);

            len = textGlyphWidths.slice(starts, ends).reduce(<span class="hljs-function">(<span class="hljs-params">a, v</span>) =&gt;</span> a + v, <span class="hljs-number">0</span>);
            textLineWidths.push(len);

            lineLen -= len;
            starts = ends + <span class="hljs-number">1</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Need to pick up the last (or only) line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (i + <span class="hljs-number">1</span> === iz) {</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Pick up single line</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (lineLen === totalLen) {

                fragment = <span class="hljs-keyword">this</span>.text;

                textLines.push(fragment);
                textLineWords.push((treatWordAsGlyph) ? fragment.split(<span class="hljs-string">' '</span>).length - <span class="hljs-number">1</span> : fragment.split(<span class="hljs-string">' '</span>).length);
                textLineWidths.push(totalLen);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>Final line of multiline text</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> {

                fragment = textGlyphs.slice(starts).join(<span class="hljs-string">''</span>);
                textLines.push(fragment);
                len = (treatWordAsGlyph) ? fragment.split(<span class="hljs-string">' '</span>).length - <span class="hljs-number">1</span> : fragment.split(<span class="hljs-string">' '</span>).length;
                textLineWords.push(len);

                len = textGlyphWidths.slice(starts).reduce(<span class="hljs-function">(<span class="hljs-params">a, v</span>) =&gt;</span> a + v, <span class="hljs-number">0</span>);
                textLineWidths.push(len);
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>… And complete the population of data for <code>highlight</code>, <code>overline</code>, <code>underline</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (xt(glyphArr[<span class="hljs-number">3</span>])) highlightFlag = glyphArr[<span class="hljs-number">3</span>];
        <span class="hljs-keyword">if</span> (xt(glyphArr[<span class="hljs-number">4</span>])) underlineFlag = glyphArr[<span class="hljs-number">4</span>];
        <span class="hljs-keyword">if</span> (xt(glyphArr[<span class="hljs-number">5</span>])) overlineFlag = glyphArr[<span class="hljs-number">5</span>];

        glyphArr[<span class="hljs-number">3</span>] = highlightFlag;
        glyphArr[<span class="hljs-number">4</span>] = underlineFlag;
        glyphArr[<span class="hljs-number">5</span>] = overlineFlag;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Handle path positioning (which we’ll assume will need to be done for every display cycle) separately during stamping</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!path) {</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <ol start="7">
<li>Calculate <code>localHeight</code></li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (scale &lt;= <span class="hljs-number">0</span>) scale = <span class="hljs-number">1</span>;
        dims[<span class="hljs-number">1</span>] = ((((textLines.length - <span class="hljs-number">1</span>) * maxHeight) * lineHeight) + maxHeight) / scale;

        <span class="hljs-keyword">this</span>.cleanHandle();
        <span class="hljs-keyword">this</span>.dirtyHandle = <span class="hljs-literal">false</span>;
        handle = <span class="hljs-keyword">this</span>.currentHandle;
        
        handleX = -handle[<span class="hljs-number">0</span>] * scale;
        handleY = -handle[<span class="hljs-number">1</span>] * scale;</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <ol start="8">
<li>We should now be in a position where we can calculate each glyph’s <code>startXY</code> values</li>
</ol>
<ul>
<li>We have 2 non-path scenarios: full-justified text; and regular text</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Scenario 1: <code>justify === &#39;full&#39;</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (justify === <span class="hljs-string">'full'</span>) {

            cursor = <span class="hljs-number">0</span>;
            height = handleY + (maxHeight / <span class="hljs-number">2</span>);

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = textLineWidths.length; i &lt; iz; i++) {

                len = handleX;

                <span class="hljs-keyword">if</span> (textLineWords[i] &gt; <span class="hljs-number">1</span>) space = (width - textLineWidths[i]) / (textLineWords[i] - <span class="hljs-number">1</span>);
                <span class="hljs-keyword">else</span> space = <span class="hljs-number">0</span>;

                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, jz = textLines[i].length; j &lt; jz; j++) {

                    item = textPositions[cursor];

                    <span class="hljs-keyword">if</span> (item[<span class="hljs-number">6</span>] === <span class="hljs-string">' '</span>) textGlyphWidths[cursor] += space;

                    item[<span class="hljs-number">7</span>] = len;
                    item[<span class="hljs-number">8</span>] = height;
                    item[<span class="hljs-number">9</span>] = textGlyphWidths[cursor];

                    len += textGlyphWidths[cursor];

                    cursor++;
                }

                cursor++;
                height += (maxHeight * lineHeight);
            }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Scenario 2: regular text - <code>justify === &#39;left&#39;</code>, or <code>&#39;centre&#39;</code>, or <code>&#39;right&#39;</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> {

            cursor = <span class="hljs-number">0</span>;
            height = handleY + (maxHeight / <span class="hljs-number">2</span>);

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = textLineWidths.length; i &lt; iz; i++) {

                <span class="hljs-keyword">if</span> (justify === <span class="hljs-string">'right'</span>) len = (width - textLineWidths[i]) + handleX;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (justify === <span class="hljs-string">'center'</span>) len = ((width - textLineWidths[i]) / <span class="hljs-number">2</span>) + handleX;
                <span class="hljs-keyword">else</span> len = handleX;

                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, jz = textLines[i].length; j &lt; jz; j++) {

                    item = textPositions[cursor];

                    item[<span class="hljs-number">7</span>] = len;
                    item[<span class="hljs-number">8</span>] = height;
                    item[<span class="hljs-number">9</span>] = textGlyphWidths[cursor];

                    len += textGlyphWidths[cursor];

                    cursor++;
                }

                cursor++;
                height += (maxHeight * lineHeight);
            }
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <ol start="9">
<li>Clean up and exit</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.textGlyphs = textGlyphs;
    <span class="hljs-keyword">this</span>.textGlyphWidths = textGlyphWidths;
    <span class="hljs-keyword">this</span>.textLines = textLines;
    <span class="hljs-keyword">this</span>.textLineWidths = textLineWidths;
    <span class="hljs-keyword">this</span>.textLineWords = textLineWords;
    <span class="hljs-keyword">this</span>.textPositions = textPositions;
    <span class="hljs-keyword">this</span>.textHeight = maxHeight;
    <span class="hljs-keyword">this</span>.textLength = totalLen;
    <span class="hljs-keyword">this</span>.fontLibrary = fontLibrary;

    releaseCell(myCell);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <h5 id="stamping-the-entity-onto-a-cell-wrapper-canvas-element">Stamping the entity onto a Cell wrapper &lt;canvas&gt; element</h5>

            </div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p><code>regularStampSynchronousActions</code> - overwrites the mixin/entity.js function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.regularStampSynchronousActions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> dest = <span class="hljs-keyword">this</span>.currentHost, 
        method = <span class="hljs-keyword">this</span>.method,
        engine, i, iz, pos, data,
        preStamper = <span class="hljs-keyword">this</span>.preStamper,
        stamper = <span class="hljs-keyword">this</span>.stamper;

    <span class="hljs-keyword">if</span> (dest) {

        engine = dest.engine;

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.noCanvasEngineUpdates) dest.setEngine(<span class="hljs-keyword">this</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.method === <span class="hljs-string">'none'</span>) {

            <span class="hljs-keyword">this</span>.performRotation(engine);
        }

        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.textPath) {

            <span class="hljs-keyword">this</span>.getTextPath();
            <span class="hljs-keyword">this</span>.calculateGlyphPathPositions();

            pos = <span class="hljs-keyword">this</span>.textPositions;

            <span class="hljs-keyword">let</span> item, pathData,
                addTextPathRoll = <span class="hljs-keyword">this</span>.addTextPathRoll,
                aPR = <span class="hljs-keyword">this</span>.addPathRotation,
                cr = <span class="hljs-keyword">this</span>.currentRotation;

            <span class="hljs-keyword">this</span>.addPathRotation = addTextPathRoll;

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = pos.length; i &lt; iz; i++) {

                item = pos[i];

                pathData = item[<span class="hljs-number">10</span>];

                <span class="hljs-keyword">if</span> (pathData) {

                    <span class="hljs-keyword">this</span>.currentPathData = pathData;
                    <span class="hljs-keyword">if</span> (addTextPathRoll) <span class="hljs-keyword">this</span>.currentRotation = pathData.angle;

                    dest.rotateDestination(engine, pathData.x, pathData.y, <span class="hljs-keyword">this</span>);

                    data = preStamper(engine, <span class="hljs-keyword">this</span>, item);
                    stamper[method](engine, <span class="hljs-keyword">this</span>, data);
                }
            }

            <span class="hljs-keyword">this</span>.addPathRotation = aPR;
            <span class="hljs-keyword">this</span>.currentRotation = cr;
        }

        <span class="hljs-keyword">else</span> {

            pos = <span class="hljs-keyword">this</span>.textPositions;

            <span class="hljs-keyword">this</span>.performRotation(engine);

            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = pos.length; i &lt; iz; i++) {

                data = preStamper(engine, <span class="hljs-keyword">this</span>, pos[i]);
                stamper[method](engine, <span class="hljs-keyword">this</span>, data);
            }

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.showBoundingBox) <span class="hljs-keyword">this</span>.drawBoundingBox(engine);
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p><code>calculateGlyphPathPositions</code> - internal helper function called by <code>regularStampSynchronousActions</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.calculateGlyphPathPositions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> path = <span class="hljs-keyword">this</span>.getTextPath(),
        len = path.length,
        textPos = <span class="hljs-keyword">this</span>.textPositions,
        widths = <span class="hljs-keyword">this</span>.textGlyphWidths,
        direction = (<span class="hljs-keyword">this</span>.textPathDirection === <span class="hljs-string">'ltr'</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>,
        pathPos = <span class="hljs-keyword">this</span>.textPathPosition,
        distance, posArray, i, iz, width,
        justify = <span class="hljs-keyword">this</span>.justify,
        loop = <span class="hljs-keyword">this</span>.textPathLoop;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = textPos.length; i &lt; iz; i++) {

        posArray = textPos[i];
        width = widths[i];</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>TODO - using non-left justified text buggers up letter kerning along the line</p>
<ul>
<li>But left-justified makes the letters lean a little to the left</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (justify === <span class="hljs-string">'right'</span>) posArray[<span class="hljs-number">7</span>] = -width;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (justify === <span class="hljs-string">'center'</span>) posArray[<span class="hljs-number">7</span>] = -width / <span class="hljs-number">2</span>;

        posArray[<span class="hljs-number">10</span>] = (pathPos &lt;= <span class="hljs-number">1</span> &amp;&amp; pathPos &gt;= <span class="hljs-number">0</span>) ? path.getPathPositionData(pathPos) : <span class="hljs-literal">false</span>;
        posArray[<span class="hljs-number">9</span>] = width;

        <span class="hljs-keyword">if</span> (direction) pathPos += (width / len);
        <span class="hljs-keyword">else</span> pathPos -= (width / len);

        <span class="hljs-keyword">if</span> (loop &amp;&amp; (pathPos &gt; <span class="hljs-number">1</span> || pathPos &lt; <span class="hljs-number">0</span>)) {

            pathPos = (pathPos &gt; <span class="hljs-number">0.5</span>) ? pathPos - <span class="hljs-number">1</span> : pathPos + <span class="hljs-number">1</span>;
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p><code>preStamper</code> - internal helper function called by <code>regularStampSynchronousActions</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.preStamper = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine, entity, args</span>) </span>{

    <span class="hljs-keyword">let</span> [font, strokeStyle, fillStyle, highlight, underline, overline, ...data] = args;

    <span class="hljs-keyword">if</span> (font) engine.font = font;

    <span class="hljs-keyword">if</span> (highlight || underline || overline) {

        <span class="hljs-keyword">let</span> highlightStyle = entity.highlightStyle,
            height = entity.textHeight,
            halfHeight = height / <span class="hljs-number">2</span>,
            underlineStyle = entity.underlineStyle,
            underlinePosition = entity.underlinePosition,
            overlineStyle = entity.overlineStyle,
            overlinePosition = entity.overlinePosition;

        engine.save();

        <span class="hljs-keyword">if</span> (highlight) {

            engine.fillStyle = highlightStyle;
            engine.fillRect(data[<span class="hljs-number">1</span>], data[<span class="hljs-number">2</span>] - halfHeight, data[<span class="hljs-number">3</span>], height);
        }

        <span class="hljs-keyword">if</span> (underline) {

            engine.strokeStyle = underlineStyle;
            engine.strokeRect(data[<span class="hljs-number">1</span>], data[<span class="hljs-number">2</span>] - halfHeight + (height * underlinePosition), data[<span class="hljs-number">3</span>], <span class="hljs-number">1</span>);
        }

        <span class="hljs-keyword">if</span> (overline) {

            engine.strokeStyle = overlineStyle;
            engine.strokeRect(data[<span class="hljs-number">1</span>], data[<span class="hljs-number">2</span>] - halfHeight + (height * overlinePosition), data[<span class="hljs-number">3</span>], <span class="hljs-number">1</span>);
        }

        engine.restore();
    }

    <span class="hljs-keyword">if</span> (strokeStyle) engine.strokeStyle = strokeStyle;
    <span class="hljs-keyword">if</span> (fillStyle) engine.fillStyle = fillStyle;

    <span class="hljs-keyword">return</span> data;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p><code>stamper</code> - object holding stamp method functions - functions called by <code>regularStampSynchronousActions</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.stamper = {</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p><code>stamper.draw</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    draw: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine, entity, data</span>) </span>{ 

        engine.strokeText(...data);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p><code>stamper.fill</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fill: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine, entity, data</span>) </span>{ 

        engine.fillText(...data);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p><code>stamper.drawAndFill</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    drawAndFill: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine, entity, data</span>) </span>{ 

        engine.strokeText(...data);
        entity.currentHost.clearShadow();
        engine.fillText(...data);
        entity.currentHost.restoreShadow(entity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p><code>stamper.fillAndDraw</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fillAndDraw: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine, entity, data</span>) </span>{ 

        engine.strokeText(...data);
        entity.currentHost.clearShadow();
        engine.fillText(...data);
        engine.strokeText(...data);
        entity.currentHost.restoreShadow(entity);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p><code>stamper.drawThenFill</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    drawThenFill: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine, entity, data</span>) </span>{ 

        engine.strokeText(...data);
        engine.fillText(...data);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p><code>stamper.fillThenDraw</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fillThenDraw: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine, entity, data</span>) </span>{ 

        engine.fillText(...data);
        engine.strokeText(...data);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p><code>stamper.clear</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clear: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine, entity, data</span>) </span>{ 

        <span class="hljs-keyword">let</span> gco = engine.globalCompositeOperation;
        engine.globalCompositeOperation = <span class="hljs-string">'destination-out'</span>;
        engine.fillText(...data);
        engine.globalCompositeOperation = gco;
    },    
};</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p><code>drawBoundingBox</code> - internal helper function called by <code>regularStampSynchronousActions</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.drawBoundingBox = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">let</span> handle = <span class="hljs-keyword">this</span>.currentHandle,
        dims = <span class="hljs-keyword">this</span>.currentDimensions,
        scale = <span class="hljs-keyword">this</span>.currentScale,
        floor = <span class="hljs-built_in">Math</span>.floor,
        ceil = <span class="hljs-built_in">Math</span>.ceil;

    engine.save();
    engine.strokeStyle = <span class="hljs-keyword">this</span>.boundingBoxColor;
    engine.lineWidth = <span class="hljs-number">1</span>;
    engine.globalCompositeOperation = <span class="hljs-string">'source-over'</span>;
    engine.globalAlpha = <span class="hljs-number">1</span>;
    engine.shadowOffsetX = <span class="hljs-number">0</span>;
    engine.shadowOffsetY = <span class="hljs-number">0</span>;
    engine.shadowBlur = <span class="hljs-number">0</span>;
    engine.strokeRect(floor(-handle[<span class="hljs-number">0</span>] * scale), floor(-handle[<span class="hljs-number">1</span>] * scale), ceil(dims[<span class="hljs-number">0</span>] * scale), ceil(dims[<span class="hljs-number">1</span>] * scale));
    engine.restore();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              <p><code>performRotation</code> - internal helper function called by <code>regularStampSynchronousActions</code></p>
<ul>
<li>When doing text along a path, we have to perform a rendering context transformation for every glyph</li>
<li>In other cases, we perform the action on a per-line basis</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.performRotation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">let</span> dest = <span class="hljs-keyword">this</span>.currentHost;

    <span class="hljs-keyword">if</span> (dest) {

        <span class="hljs-keyword">let</span> stamp = <span class="hljs-keyword">this</span>.currentStampPosition;

        dest.rotateDestination(engine, stamp[<span class="hljs-number">0</span>], stamp[<span class="hljs-number">1</span>], <span class="hljs-keyword">this</span>);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <h4 id="factory">Factory</h4>
<pre><code>scrawl.makePhrase({

    <span class="hljs-attr">name</span>: <span class="hljs-string">'myphrase_fill'</span>,

    <span class="hljs-attr">text</span>: <span class="hljs-string">'H&amp;epsilon;lj&amp;ouml;!'</span>,
    <span class="hljs-attr">font</span>: <span class="hljs-string">'bold 40px Garamond, serif'</span>,

    <span class="hljs-attr">width</span>: <span class="hljs-number">120</span>,

    <span class="hljs-attr">startX</span>: <span class="hljs-string">'14%'</span>,
    <span class="hljs-attr">startY</span>: <span class="hljs-string">'28%'</span>,
    <span class="hljs-attr">handleX</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">handleY</span>: <span class="hljs-string">'center'</span>,

    <span class="hljs-attr">justify</span>: <span class="hljs-string">'center'</span>,
    <span class="hljs-attr">lineHeight</span>: <span class="hljs-number">1</span>,

    <span class="hljs-attr">fillStyle</span>: <span class="hljs-string">'green'</span>,
    <span class="hljs-attr">strokeStyle</span>: <span class="hljs-string">'gold'</span>,

    <span class="hljs-attr">lineWidth</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">lineJoin</span>: <span class="hljs-string">'round'</span>,

    <span class="hljs-attr">shadowOffsetX</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">shadowOffsetY</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">shadowBlur</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">shadowColor</span>: <span class="hljs-string">'black'</span>,

}).clone({

    <span class="hljs-attr">name</span>: <span class="hljs-string">'myphrase_draw'</span>,
    <span class="hljs-attr">startX</span>: <span class="hljs-string">'38%'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'draw'</span>,
});</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> makePhrase = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Phrase(items);
};

constructors.Phrase = Phrase;</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <h4 id="exports">Exports</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">export</span> {
    makePhrase,
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
