<!DOCTYPE html>

<html>
<head>
  <title>Loom factory</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../../demo/canvas-001.html">
                  ./demo/canvas-001.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-002.html">
                  ./demo/canvas-002.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-003.html">
                  ./demo/canvas-003.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-004.html">
                  ./demo/canvas-004.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-005.html">
                  ./demo/canvas-005.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-006.html">
                  ./demo/canvas-006.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-007.html">
                  ./demo/canvas-007.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-008.html">
                  ./demo/canvas-008.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-009.html">
                  ./demo/canvas-009.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-010.html">
                  ./demo/canvas-010.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-011.html">
                  ./demo/canvas-011.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-012.html">
                  ./demo/canvas-012.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-013.html">
                  ./demo/canvas-013.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-014.html">
                  ./demo/canvas-014.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-015.html">
                  ./demo/canvas-015.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-016.html">
                  ./demo/canvas-016.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-017.html">
                  ./demo/canvas-017.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-018.html">
                  ./demo/canvas-018.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-019.html">
                  ./demo/canvas-019.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-020.html">
                  ./demo/canvas-020.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-021.html">
                  ./demo/canvas-021.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-022.html">
                  ./demo/canvas-022.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-023.html">
                  ./demo/canvas-023.js
                </a>
              
                
                <a class="source" href="../../demo/canvas-024.html">
                  ./demo/canvas-024.js
                </a>
              
                
                <a class="source" href="../../demo/component-001.html">
                  ./demo/component-001.js
                </a>
              
                
                <a class="source" href="../../demo/component-002.html">
                  ./demo/component-002.js
                </a>
              
                
                <a class="source" href="../../demo/component-003.html">
                  ./demo/component-003.js
                </a>
              
                
                <a class="source" href="../../demo/component-004.html">
                  ./demo/component-004.js
                </a>
              
                
                <a class="source" href="../../demo/components/test-001.html">
                  ./demo/components/test-001.js
                </a>
              
                
                <a class="source" href="../../demo/components/test-002.html">
                  ./demo/components/test-002.js
                </a>
              
                
                <a class="source" href="../../demo/core-001.html">
                  ./demo/core-001.js
                </a>
              
                
                <a class="source" href="../../demo/dom-001.html">
                  ./demo/dom-001.js
                </a>
              
                
                <a class="source" href="../../demo/dom-002.html">
                  ./demo/dom-002.js
                </a>
              
                
                <a class="source" href="../../demo/dom-003.html">
                  ./demo/dom-003.js
                </a>
              
                
                <a class="source" href="../../demo/dom-004.html">
                  ./demo/dom-004.js
                </a>
              
                
                <a class="source" href="../../demo/dom-005.html">
                  ./demo/dom-005.js
                </a>
              
                
                <a class="source" href="../../demo/dom-006.html">
                  ./demo/dom-006.js
                </a>
              
                
                <a class="source" href="../../demo/dom-007.html">
                  ./demo/dom-007.js
                </a>
              
                
                <a class="source" href="../../demo/dom-008.html">
                  ./demo/dom-008.js
                </a>
              
                
                <a class="source" href="../../demo/dom-009.html">
                  ./demo/dom-009.js
                </a>
              
                
                <a class="source" href="../../demo/dom-010.html">
                  ./demo/dom-010.js
                </a>
              
                
                <a class="source" href="../../demo/dom-011.html">
                  ./demo/dom-011.js
                </a>
              
                
                <a class="source" href="../../demo/dom-012.html">
                  ./demo/dom-012.js
                </a>
              
                
                <a class="source" href="../../demo/dom-013.html">
                  ./demo/dom-013.js
                </a>
              
                
                <a class="source" href="../../demo/dom-014a.html">
                  ./demo/dom-014a.js
                </a>
              
                
                <a class="source" href="../../demo/dom-014b.html">
                  ./demo/dom-014b.js
                </a>
              
                
                <a class="source" href="../../demo/dom-014c.html">
                  ./demo/dom-014c.js
                </a>
              
                
                <a class="source" href="../../demo/dom-015.html">
                  ./demo/dom-015.js
                </a>
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="userObject.html">
                  ./source/factory/userObject.js
                </a>
              
                
                <a class="source" href="vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../scrawl.html">
                  ./source/scrawl.js
                </a>
              
                
                <a class="source" href="../worker/filter.html">
                  ./source/worker/filter.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="loom-factory">Loom factory</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4 id="to-instantiate-objects-from-the-factory">To instantiate objects from the factory</h4>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4 id="library-storage">Library storage</h4>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h4 id="clone-functionality">Clone functionality</h4>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h4 id="kill-functionality">Kill functionality</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { constructors, artefact } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/library.js'</span>;
<span class="hljs-keyword">import</span> { currentGroup } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/document.js'</span>;
<span class="hljs-keyword">import</span> { mergeOver, mergeDiscard, pushUnique, defaultNonReturnFunction, defaultThisReturnFunction, xta } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/utilities.js'</span>;

<span class="hljs-keyword">import</span> { makeState } <span class="hljs-keyword">from</span> <span class="hljs-string">'../factory/state.js'</span>;
<span class="hljs-keyword">import</span> { requestCell, releaseCell } <span class="hljs-keyword">from</span> <span class="hljs-string">'../factory/cell.js'</span>;

<span class="hljs-keyword">import</span> baseMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/base.js'</span>;
<span class="hljs-keyword">import</span> anchorMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/anchor.js'</span>;
<span class="hljs-keyword">import</span> filterMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/filter.js'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="loom-constructor">Loom constructor</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> Loom = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">this</span>.makeName(items.name);
    <span class="hljs-keyword">this</span>.register();

    <span class="hljs-keyword">this</span>.set(<span class="hljs-keyword">this</span>.defs);

    <span class="hljs-keyword">this</span>.state = makeState();

    <span class="hljs-keyword">if</span> (!items.group) items.group = currentGroup;

    <span class="hljs-keyword">this</span>.onEnter = defaultNonReturnFunction;
    <span class="hljs-keyword">this</span>.onLeave = defaultNonReturnFunction;
    <span class="hljs-keyword">this</span>.onDown = defaultNonReturnFunction;
    <span class="hljs-keyword">this</span>.onUp = defaultNonReturnFunction;

    <span class="hljs-keyword">this</span>.delta = {};

    <span class="hljs-keyword">this</span>.set(items);

    <span class="hljs-keyword">this</span>.fromPathData = [];
    <span class="hljs-keyword">this</span>.toPathData = [];

    <span class="hljs-keyword">this</span>.watchFromPath = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.watchIndex = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">this</span>.engineInstructions = [];
    <span class="hljs-keyword">this</span>.engineDeltaLengths = [];

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="loom-object-prototype-setup">Loom object prototype setup</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> P = Loom.prototype = <span class="hljs-built_in">Object</span>.create(<span class="hljs-built_in">Object</span>.prototype);
P.type = <span class="hljs-string">'Loom'</span>;
P.lib = <span class="hljs-string">'entity'</span>;
P.isArtefact = <span class="hljs-literal">true</span>;
P.isAsset = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Apply mixins to prototype object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P = baseMix(P);
P = anchorMix(P);
P = filterMix(P);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h2 id="define-default-attributes">Define default attributes</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>A Loom entity uses 2 Shape paths to construct a frame between which the image will be redrawn.</p>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>The positioning, scaling etc of each strut is set in the constituent Shape entitys, not the Loom entity. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fromPath: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">toPath</span>: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>The Loom entity can set the start and end cursors on each of its path struts, between which the image will be drawn. These can be animated to allow the image to ‘flow’ between one part of the display and another, changing its shape as it moves</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fromPathStart: <span class="hljs-number">0</span>,
    <span class="hljs-attr">fromPathEnd</span>: <span class="hljs-number">1</span>,

    <span class="hljs-attr">toPathStart</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">toPathEnd</span>: <span class="hljs-number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>To make sure the ‘from’ and ‘to’ strut start points, and end points, have the same value set the Loom’s <strong>synchronizePathCursors</strong> attribute to true (default). Setting it to ‘false’ allows the cursors to be set independently on each strut … which in turn may lead to unexpected display consequences</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    synchronizePathCursors: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>For animation purposes, the image will move between the struts with the bottom of the page appearing again at the top of the Loom as it moves down (and vice versa). To change this functionality - so that the image slowly disappears as it animates up and down past the ends of the struts, set the <strong>loopPathCursors</strong> attribute to false</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    loopPathCursors: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Copying the source image to the output happens, by default, by rows - which effectively means the struts are on the left-hand and right-hand edges of the image. </p>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>To change this to columns (which sets the struts to the top and bottom edges of the image) set the ‘isHorizontalCopy’ attribute to false </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    isHorizontalCopy: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Mainly for library development/testing work - shows the loom entity’s bounding box - which is calculated from the constituent Shape entitys’ current bounding boxes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    showBoundingBox: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">boundingBoxColor</span>: <span class="hljs-string">'#000000'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>The Picture entity source for this loom. For initialization and/or set, we can supply either the Picture entity itself, or its string name attribute</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>The content image displayed by the Loom entity are set in the Picture entity, not the Loom, and can be any artefact supported by the Picture (image, video, sprite, or a Cell artefact)</p>

            </div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Note that any filters should be applied to the Picture entity; Loom entitys do not support filter functionality but will apply a Picture’s filters to the source image as-and-where appropriate</p>

            </div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>If the Picture entity is hosting a video or sprite asset, we need to update the input on every frame. It’s easier to tell the Loom entity to do this using a flag, rather than get the Picture entity to update all its Loom subscribers on every display cycle. For Pictures using image assets the <strong>sourceIsVideoOrSprite</strong> flag must be set to false (the default); setting the flag to true will significantly degrade display and animation performance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    source: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">sourceIsVideoOrSprite</span>: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>The current Frame drawing process often leads to moire interference patterns appearing in the resulting image. Scrawl uses resizing to blur out these patterns. </p>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>The interferenceFactor attribute sets the resizing ratio; while he interferenceLoops attribute sets the number of times the image gets resized. </p>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If patterns still appear in the final image, tweak these values to see if a better output can be achieved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    interferenceLoops: <span class="hljs-number">2</span>,
    <span class="hljs-attr">interferenceFactor</span>: <span class="hljs-number">1.03</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>The Loom entity does not use the <strong>position</strong> and <strong>entity</strong> mixins (used by most other entitys) as its positioning is entirely dependent on the position, rotation, scale etc of its constituent Shape path entity struts. It does, however, require these attributes (alongside their setters and getters)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    visibility: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">order</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">delta</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">host</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">group</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">anchor</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">collides</span>: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Canvas engine updates are required for the Loom’s border - strokeStyle and line styling; if a Loom is to be drawn without a border, then setting the <strong>noCanvasEngineUpdates</strong> attribute to true may help improve rendering efficiency</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    noCanvasEngineUpdates: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Loom entitys support delta animation - achieved by updating the fromPathStart, fromPathEnd, toPathStart and toPathEnd attributes by appropriate (and small!) values. If the Loom is not going to be animated by delta values, setting the <strong>noDeltaUpdates</strong> attributes to true may help improve rendering efficiency</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    noDeltaUpdates: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Loom entitys support <strong>collision detection</strong>, reporting a hit when a test coordinate falls within the Loom’s output image. As a result, Looms can also accept and act on the four <strong>on</strong> functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    onEnter: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">onLeave</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">onDown</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">onUp</span>: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>To switch off collision detection for a Loom entity - which might help improve rendering efficiency - set the <strong>noUserInteraction</strong> attribute to true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    noUserInteraction: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Anchor objects can also be assigned to Loom entitys, meaning the following attributes are supported</p>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <ul>
<li>anchorDescription</li>
<li>anchorType</li>
<li>anchorTarget</li>
<li>anchorRel</li>
<li>anchorReferrerPolicy</li>
<li>anchorPing</li>
<li>anchorHreflang</li>
<li>anchorHref</li>
<li>anchorDownload</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>And the anchor attributes can also be supplied as a key:value object assigned to the <strong>anchor</strong> attribute:</p>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <pre><code>anchor: {
    description
    download
    href
    hreflang
    ping
    referrerpolicy
    <span class="hljs-attr">rel</span>:
    target:
    anchorType
    <span class="hljs-attr">clickAction</span>: 
}</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Note that Loom entitys DO NOT SUPPORT the sensor component of the Scrawl-canvas collisions system and will return an empty array when asked to supply sensor coordinates for testing against other artefacts.</p>

            </div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>All normal Scrawl-canvas entity stamping methods are supported</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    method: <span class="hljs-string">'fill'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Loom entitys support appropriate styling attributes, mainly for their stroke styles (used with the ‘draw’, ‘drawAndFill’, ‘fillAndDraw’, ‘drawThenFill’ and ‘fillThenDraw’ stamping methods)</p>

            </div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>The following attributes are thus supported:</p>

            </div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <ul>
<li>globalAlpha</li>
<li>globalCompositeOperation</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Alpha and Composite operations will be applied to both the Loom entity’s border (the Shape entitys, with connecting lines between their paths’ start and end points) and fill (the image displayed between the Loom’s struts)</p>

            </div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <ul>
<li>lineWidth</li>
<li>lineCap</li>
<li>lineJoin</li>
<li>lineDash</li>
<li>lineDashOffset</li>
<li>miterLimit</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>All line attributes are supported</p>

            </div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <ul>
<li>strokeStyle</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>The Loom entity’s strokeStyle can be any style supported by Scrawl-canvas - color strings, gradient objects, and pattern objects</p>

            </div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <ul>
<li>shadowOffsetX</li>
<li>shadowOffsetY</li>
<li>shadowBlur</li>
<li>shadowColor</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>The shadow attributes will only be applied to the stroke (border), not to the Loom’s fill (image)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>};
P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <h2 id="define-getter-setter-and-deltasetter-functions">Define getter, setter and deltaSetter functions</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> G = P.getters,
    S = P.setters,
    D = P.deltaSetters;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Setters and getters copied over from the entity mixin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> getter = <span class="hljs-keyword">this</span>.getters[item];

    <span class="hljs-keyword">if</span> (getter) <span class="hljs-keyword">return</span> getter.call(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">else</span> {

        <span class="hljs-keyword">let</span> def = <span class="hljs-keyword">this</span>.defs[item],
            state = <span class="hljs-keyword">this</span>.state,
            val;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def != <span class="hljs-string">'undefined'</span>) {

            val = <span class="hljs-keyword">this</span>[item];
            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val != <span class="hljs-string">'undefined'</span>) ? val : def;
        }

        def = state.defs[item];

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def != <span class="hljs-string">'undefined'</span>) {

            val = state[item];
            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val != <span class="hljs-string">'undefined'</span>) ? val : def;
        }
        <span class="hljs-keyword">return</span> undef;
    }
};

P.set = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (items) {

        <span class="hljs-keyword">let</span> setters = <span class="hljs-keyword">this</span>.setters,
            defs = <span class="hljs-keyword">this</span>.defs,
            state = <span class="hljs-keyword">this</span>.state,
            stateSetters = (state) ? state.setters : {},
            stateDefs = (state) ? state.defs : {};

        <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">'name'</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                <span class="hljs-keyword">let</span> predefined = setters[key],
                    stateFlag = <span class="hljs-literal">false</span>;

                <span class="hljs-keyword">if</span> (!predefined) {

                    predefined = stateSetters[key];
                    stateFlag = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-keyword">if</span> (predefined) predefined.call(stateFlag ? <span class="hljs-keyword">this</span>.state : <span class="hljs-keyword">this</span>, value);
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] !== <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">this</span>[key] = value;
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> stateDefs[key] !== <span class="hljs-string">'undefined'</span>) state[key] = value;
            }
        }, <span class="hljs-keyword">this</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

P.setDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (items) {

        <span class="hljs-keyword">let</span> setters = <span class="hljs-keyword">this</span>.deltaSetters,
            defs = <span class="hljs-keyword">this</span>.defs,
            state = <span class="hljs-keyword">this</span>.state,
            stateSetters = (state) ? state.deltaSetters : {},
            stateDefs = (state) ? state.defs : {};

        <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">'name'</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                <span class="hljs-keyword">let</span> predefined = setters[key],
                    stateFlag = <span class="hljs-literal">false</span>;

                <span class="hljs-keyword">if</span> (!predefined) {

                    predefined = stateSetters[key];
                    stateFlag = <span class="hljs-literal">true</span>;
                }

                <span class="hljs-keyword">if</span> (predefined) predefined.call(stateFlag ? <span class="hljs-keyword">this</span>.state : <span class="hljs-keyword">this</span>, value);
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] !== <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">this</span>[key] = addStrings(<span class="hljs-keyword">this</span>[key], value);
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> stateDefs[key] !== <span class="hljs-string">'undefined'</span>) state[key] = addStrings(state[key], value);
            }
        }, <span class="hljs-keyword">this</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Host, group and here functionality (copied from position mixin)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.host = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (item) {

        <span class="hljs-keyword">let</span> host = artefact[item];

        <span class="hljs-keyword">if</span> (host &amp;&amp; host.here) <span class="hljs-keyword">this</span>.host = host.name;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.host = item;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.host = <span class="hljs-string">''</span>;
};
P.getHost = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentHost) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentHost;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.host) {

        <span class="hljs-keyword">let</span> host = artefact[<span class="hljs-keyword">this</span>.host];

        <span class="hljs-keyword">if</span> (host) {

            <span class="hljs-keyword">this</span>.currentHost = host;
            <span class="hljs-keyword">this</span>.dirtyHost = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentHost;
        }
    }
    <span class="hljs-keyword">return</span> currentCorePosition;
};

G.group = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.group) ? <span class="hljs-keyword">this</span>.group.name : <span class="hljs-string">''</span>;
};
S.group = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> g;

    <span class="hljs-keyword">if</span> (item) {

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.group &amp;&amp; <span class="hljs-keyword">this</span>.group.type === <span class="hljs-string">'Group'</span>) <span class="hljs-keyword">this</span>.group.removeArtefacts(<span class="hljs-keyword">this</span>.name);

        <span class="hljs-keyword">if</span> (item.substring) {

            g = group[item];

            <span class="hljs-keyword">if</span> (g) <span class="hljs-keyword">this</span>.group = g;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.group = item;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.group = item;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.group &amp;&amp; <span class="hljs-keyword">this</span>.group.type === <span class="hljs-string">'Group'</span>) <span class="hljs-keyword">this</span>.group.addArtefacts(<span class="hljs-keyword">this</span>.name);
};

P.getHere = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> currentCorePosition;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Delta functionality - copied over from position mixin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.delta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (items) <span class="hljs-keyword">this</span>.delta = mergeDiscard(<span class="hljs-keyword">this</span>.delta, items);
};
P.updateByDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">this</span>.setDelta(<span class="hljs-keyword">this</span>.delta);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

P.reverseByDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> temp = {};
    
    <span class="hljs-built_in">Object</span>.entries(<span class="hljs-keyword">this</span>.delta).forEach(<span class="hljs-function">(<span class="hljs-params">[key, val]</span>) =&gt;</span> {

        <span class="hljs-keyword">if</span> (val.substring) val = -(<span class="hljs-built_in">parseFloat</span>(val)) + <span class="hljs-string">'%'</span>;
        <span class="hljs-keyword">else</span> val = -val;

        temp[key] = val;
    });

    <span class="hljs-keyword">this</span>.setDelta(temp);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

P.setDeltaValues = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">let</span> delta = <span class="hljs-keyword">this</span>.delta, 
        oldVal, action;

    <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, requirement]</span>) =&gt;</span> {

        <span class="hljs-keyword">if</span> (xt(delta[key])) {

            action = requirement;

            oldVal = delta[key];

            <span class="hljs-keyword">switch</span> (action) {

                <span class="hljs-keyword">case</span> <span class="hljs-string">'reverse'</span> :
                    <span class="hljs-keyword">if</span> (oldVal.toFixed) delta[key] = -oldVal;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>TODO: reverse String% (and em, etc) values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">'zero'</span> :
                    <span class="hljs-keyword">if</span> (oldVal.toFixed) delta[key] = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>TODO: zero String% (and em, etc) values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">'add'</span> :
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">'subtract'</span> :
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">'multiply'</span> :
                    <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">case</span> <span class="hljs-string">'divide'</span> :
                    <span class="hljs-keyword">break</span>;
            }
        }
    })
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Invalidate mid-init functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.midInitActions = defaultNonReturnFunction;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Loom entities <strong>CANNOT BE CLONED!</strong></p>

            </div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>This is because Loom entitys are <strong>compound entitys</strong> which bring together other entitys to make a new thing. Attempting to clone a Loom would also require decsions on whether to clone the underlying entitys</p>

            </div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>(Note: I’m sure it could be done, but I’m not going to do it for Scrawl-canvas v8)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.clone = defaultThisReturnFunction;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Invalidating sensor functionality</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.cleanCollisionData = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> [<span class="hljs-number">0</span>, []];
};
P.getSensors = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> [];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.fromPath = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (item) {

        <span class="hljs-keyword">let</span> oldPath = <span class="hljs-keyword">this</span>.fromPath,
            newPath = (item.substring) ? artefact[item] : item,
            name = <span class="hljs-keyword">this</span>.name;

        <span class="hljs-keyword">if</span> (newPath &amp;&amp; newPath.name &amp;&amp; newPath.useAsPath) {

            <span class="hljs-keyword">if</span> (oldPath &amp;&amp; oldPath.name !== newPath.name) removeItem(oldPath.pathed, name);

            pushUnique(newPath.pathed, name);

            <span class="hljs-keyword">this</span>.fromPath = newPath;

            <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
        }
    }
};

S.toPath = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (item) {

        <span class="hljs-keyword">let</span> oldPath = <span class="hljs-keyword">this</span>.toPath,
            newPath = (item.substring) ? artefact[item] : item,
            name = <span class="hljs-keyword">this</span>.name;

        <span class="hljs-keyword">if</span> (newPath &amp;&amp; newPath.name &amp;&amp; newPath.useAsPath) {

            <span class="hljs-keyword">if</span> (oldPath &amp;&amp; oldPath.name !== newPath.name) removeItem(oldPath.pathed, name);

            pushUnique(newPath.pathed, name);

            <span class="hljs-keyword">this</span>.toPath = newPath;

            <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">true</span>;
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.source = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    item = (item.substring) ? artefact[item] : item;

    <span class="hljs-keyword">if</span> (item &amp;&amp; item.type === <span class="hljs-string">'Picture'</span>) {

        <span class="hljs-keyword">let</span> src = <span class="hljs-keyword">this</span>.source;

        <span class="hljs-keyword">if</span> (src &amp;&amp; src.type === <span class="hljs-string">'Picture'</span>) src.imageUnsubscribe(<span class="hljs-keyword">this</span>.name);

        <span class="hljs-keyword">this</span>.source = item;
        item.imageSubscribe(<span class="hljs-keyword">this</span>.name);
        <span class="hljs-keyword">this</span>.dirtyInput = <span class="hljs-literal">true</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.isHorizontalCopy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.isHorizontalCopy = (item) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.synchronizePathCursors = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.synchronizePathCursors = (item) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (item) {

        <span class="hljs-keyword">this</span>.toPathStart = <span class="hljs-keyword">this</span>.fromPathStart;
        <span class="hljs-keyword">this</span>.toPathEnd = <span class="hljs-keyword">this</span>.fromPathEnd;
    }

    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.loopPathCursors = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.loopPathCursors = (item) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (item) {

        <span class="hljs-keyword">let</span> c,
            floor = <span class="hljs-built_in">Math</span>.floor;

        c = <span class="hljs-keyword">this</span>.fromPathStart
        <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span> || c &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">this</span>.fromPathStart = c - floor(c);

        c = <span class="hljs-keyword">this</span>.fromPathEnd
        <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span> || c &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">this</span>.fromPathEnd = c - floor(c);

        c = <span class="hljs-keyword">this</span>.toPathStart
        <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span> || c &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">this</span>.toPathStart = c - floor(c);

        c = <span class="hljs-keyword">this</span>.toPathEnd
        <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span> || c &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">this</span>.toPathEnd = c - floor(c);
    }

    <span class="hljs-keyword">this</span>.dirtyOutput = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.fromPathStart = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loopPathCursors &amp;&amp; (item &lt; <span class="hljs-number">0</span> || item &gt; <span class="hljs-number">1</span>)) item = item - <span class="hljs-built_in">Math</span>.floor(item);
    <span class="hljs-keyword">this</span>.fromPathStart = item;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.synchronizePathCursors) <span class="hljs-keyword">this</span>.toPathStart = item;
    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};
S.fromPathEnd = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loopPathCursors &amp;&amp; (item &lt; <span class="hljs-number">0</span> || item &gt; <span class="hljs-number">1</span>)) item = item - <span class="hljs-built_in">Math</span>.floor(item);
    <span class="hljs-keyword">this</span>.fromPathEnd = item;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.synchronizePathCursors) <span class="hljs-keyword">this</span>.toPathEnd = item;
    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};
S.toPathStart = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loopPathCursors &amp;&amp; (item &lt; <span class="hljs-number">0</span> || item &gt; <span class="hljs-number">1</span>)) item = item - <span class="hljs-built_in">Math</span>.floor(item);
    <span class="hljs-keyword">this</span>.toPathStart = item;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.synchronizePathCursors) <span class="hljs-keyword">this</span>.fromPathStart = item;
    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};
S.toPathEnd = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loopPathCursors &amp;&amp; (item &lt; <span class="hljs-number">0</span> || item &gt; <span class="hljs-number">1</span>)) item = item - <span class="hljs-built_in">Math</span>.floor(item);
    <span class="hljs-keyword">this</span>.toPathEnd = item;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.synchronizePathCursors) <span class="hljs-keyword">this</span>.fromPathEnd = item;
    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};
D.fromPathStart = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> val = <span class="hljs-keyword">this</span>.fromPathStart += item;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loopPathCursors &amp;&amp; (val &lt; <span class="hljs-number">0</span> || val &gt; <span class="hljs-number">1</span>)) val = val - <span class="hljs-built_in">Math</span>.floor(val);
    <span class="hljs-keyword">this</span>.fromPathStart = val;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.synchronizePathCursors) <span class="hljs-keyword">this</span>.toPathStart = val;
    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};
D.fromPathEnd = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> val = <span class="hljs-keyword">this</span>.fromPathEnd += item;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loopPathCursors &amp;&amp; (val &lt; <span class="hljs-number">0</span> || val &gt; <span class="hljs-number">1</span>)) val = val - <span class="hljs-built_in">Math</span>.floor(val);
    <span class="hljs-keyword">this</span>.fromPathEnd = val;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.synchronizePathCursors) <span class="hljs-keyword">this</span>.toPathEnd = val;
    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};
D.toPathStart = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> val = <span class="hljs-keyword">this</span>.toPathStart += item;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loopPathCursors &amp;&amp; (val &lt; <span class="hljs-number">0</span> || val &gt; <span class="hljs-number">1</span>)) val = val - <span class="hljs-built_in">Math</span>.floor(val);
    <span class="hljs-keyword">this</span>.toPathStart = val;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.synchronizePathCursors) <span class="hljs-keyword">this</span>.fromPathStart = val;
    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};
D.toPathEnd = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> val = <span class="hljs-keyword">this</span>.toPathEnd += item;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loopPathCursors &amp;&amp; (val &lt; <span class="hljs-number">0</span> || val &gt; <span class="hljs-number">1</span>)) val = val - <span class="hljs-built_in">Math</span>.floor(val);
    <span class="hljs-keyword">this</span>.toPathEnd = val;
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.synchronizePathCursors) <span class="hljs-keyword">this</span>.fromPathEnd = val;
    <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>This function is called before we get into the entity stamp promise cascade (thus it’s a synchronous function). This is where we need to check whether we need to recalculate the path data which we’ll use later to build the Loom entity’s output image.</p>

            </div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>We only need to recalculate the path data on the initial render, and afterwards when the <strong>dirtyPathData</strong> flag has been set</p>

            </div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>If we perform the recalculation, then we need to make sure to set the <strong>dirtyOutput</strong> flag, which will trigger the output image build</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.prepareStamp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> fPath = <span class="hljs-keyword">this</span>.fromPath,
        tPath = <span class="hljs-keyword">this</span>.toPath;</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Sanity check 1</p>
<ul>
<li>getBoundingBox will recalculate and set the dirtyPathData flag 
if paths have set the Loom’s dirtyStart flag</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> [startX, startY, outputWidth, outputHeight] = <span class="hljs-keyword">this</span>.getBoundingBox();</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Sanity check 2</p>
<ul>
<li>we can set the dirtyPathData ourselves if paths start/end coordinates have changed
in case Shape path roll/scale/flip/etc updates don’t get messaged to the Loom entity</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.dirtyPathData) {

        <span class="hljs-keyword">let</span> {<span class="hljs-attr">x</span>: testFromStartX, <span class="hljs-attr">y</span>: testFromStartY} = fPath.getPathPositionData(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">let</span> {<span class="hljs-attr">x</span>: testFromEndX, <span class="hljs-attr">y</span>: testFromEndY} = fPath.getPathPositionData(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">let</span> {<span class="hljs-attr">x</span>: testToStartX, <span class="hljs-attr">y</span>: testToStartY} = tPath.getPathPositionData(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">let</span> {<span class="hljs-attr">x</span>: testToEndX, <span class="hljs-attr">y</span>: testToEndY} = tPath.getPathPositionData(<span class="hljs-number">1</span>);

        <span class="hljs-keyword">let</span> localPathTests = [testFromStartX, testFromStartY, testFromEndX, testFromEndY, testToStartX, testToStartY, testToEndX, testToEndY];

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.pathTests || <span class="hljs-keyword">this</span>.pathTests.some(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> item !== localPathTests[index])) {

            <span class="hljs-keyword">this</span>.pathTests = localPathTests;
            <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
        }
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyPathData || !<span class="hljs-keyword">this</span>.fromPathData.length) {

        <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">this</span>.watchIndex = <span class="hljs-number">-1</span>;
        <span class="hljs-keyword">this</span>.engineInstructions.length = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.engineDeltaLengths.length = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">let</span> mCeil = <span class="hljs-built_in">Math</span>.ceil,
            mMax = <span class="hljs-built_in">Math</span>.max,
            mMin = <span class="hljs-built_in">Math</span>.min,
            mFloor = <span class="hljs-built_in">Math</span>.floor;

        <span class="hljs-keyword">let</span> fromPathData = <span class="hljs-keyword">this</span>.fromPathData;
        fromPathData.length = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">let</span> toPathData = <span class="hljs-keyword">this</span>.toPathData;
        toPathData.length = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">if</span>(fPath &amp;&amp; tPath) {

            <span class="hljs-keyword">let</span> fPathLength = mCeil(fPath.length),
                tPathLength = mCeil(tPath.length),
                pathSteps, pathDelta, x, y;

            pathSteps = <span class="hljs-keyword">this</span>.setSourceDimension(mMax(fPathLength, tPathLength));

            <span class="hljs-keyword">let</span> fPathStart = <span class="hljs-keyword">this</span>.fromPathStart,
                fPathEnd = <span class="hljs-keyword">this</span>.fromPathEnd,
                tPathStart = <span class="hljs-keyword">this</span>.toPathStart,
                tPathEnd = <span class="hljs-keyword">this</span>.toPathEnd,
                fPartial, tPartial, fRatio, tRatio, minPartial;

            <span class="hljs-keyword">if</span> (fPathStart &lt; fPathEnd) fPartial = fPathEnd - fPathStart;
            <span class="hljs-keyword">else</span> fPartial = fPathEnd + (<span class="hljs-number">1</span> - fPathStart);
            <span class="hljs-keyword">if</span> (fPartial &lt; <span class="hljs-number">0.005</span>) fPartial = <span class="hljs-number">0.005</span>;

            <span class="hljs-keyword">if</span> (tPathStart &lt; tPathEnd) tPartial = tPathEnd - tPathStart;
            <span class="hljs-keyword">else</span> tPartial = tPathEnd + (<span class="hljs-number">1</span> - tPathStart);
            <span class="hljs-keyword">if</span> (tPartial &lt; <span class="hljs-number">0.005</span>) tPartial = <span class="hljs-number">0.005</span>;

            minPartial = mCeil(mMin(fPartial, tPartial));

            pathDelta = <span class="hljs-number">1</span> / (pathSteps * (<span class="hljs-number">1</span> / minPartial));

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> cursor = <span class="hljs-number">0</span>; cursor &lt;= <span class="hljs-number">1</span>; cursor += pathDelta) {

                ({x, y} = fPath.getPathPositionData(cursor));
                fromPathData.push([x - startX, y - startY]);

                ({x, y} = tPath.getPathPositionData(cursor));
                toPathData.push([x - startX, y - startY]);
            }

            <span class="hljs-keyword">this</span>.fromPathSteps = fPartial / minPartial;
            <span class="hljs-keyword">this</span>.toPathSteps = tPartial / minPartial;

            <span class="hljs-keyword">this</span>.watchFromPath = (<span class="hljs-keyword">this</span>.fromPathSteps === <span class="hljs-number">1</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">this</span>.dirtyOutput = <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.sourceIsVideoOrSprite) <span class="hljs-keyword">this</span>.dirtyInput = <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.setSourceDimension = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">val</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>prepareStamp does the dimension calculation itself, then supplies the new value</p>
<ul>
<li>we just need to update this.sourceDimension and set the dirtyInput flag</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (val) {

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.sourceDimension !== val) {

            <span class="hljs-keyword">this</span>.sourceDimension = val;
            <span class="hljs-keyword">this</span>.dirtyInput = <span class="hljs-literal">true</span>;
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>if other functions call setSourceDimension, they will do it without supplying a new value</p>
<ul>
<li>in which case we can calculate and update it here</li>
<li>other functions do it as a sanity check </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> {

        <span class="hljs-keyword">let</span> fPath = <span class="hljs-keyword">this</span>.fromPath,
            tPath = <span class="hljs-keyword">this</span>.toPath;

        <span class="hljs-keyword">if</span>(fPath &amp;&amp; tPath) {

            <span class="hljs-keyword">let</span> mCeil = <span class="hljs-built_in">Math</span>.ceil,
                fPathLength = mCeil(fPath.length),
                tPathLength = mCeil(tPath.length);

            <span class="hljs-keyword">let</span> steps = <span class="hljs-built_in">Math</span>.max(fPathLength, tPathLength);

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.sourceDimension !== steps) <span class="hljs-keyword">this</span>.sourceDimension = steps;
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.sourceDimension = <span class="hljs-number">0</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.sourceDimension;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Simple stamping is entirely synchronous</p>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>TODO: we may have to disable this functionality for the Loom entity, if we use a web worker for either the prepareStamp calculations, or to build the output image itself</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.simpleStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">host, changes = {}</span>) </span>{

    <span class="hljs-keyword">if</span> (host &amp;&amp; host.type === <span class="hljs-string">'Cell'</span>) {

        <span class="hljs-keyword">this</span>.currentHost = host;
        
        <span class="hljs-keyword">if</span> (changes) {

            <span class="hljs-keyword">this</span>.set(changes);
            <span class="hljs-keyword">this</span>.prepareStamp();
        }

        <span class="hljs-keyword">this</span>.regularStampSynchronousActions();
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>All entity stamping - except for simple stamps - goes through the asynchronous <strong>stamp</strong> function, which needs to return a promise which will resolve in due course</p>

            </div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>While other entitys have to worry about applying filters as part of the stamping process, this is not an issue for Loom entitys because filters are defined on, and applied to, the source Picture entity, not the Loom itself</p>

            </div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Instead we check which dirty flags need actioning, and call a range of different functions to process the work. These flags are:</p>

            </div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <ul>
<li>dirtyInput (the Picture entity has reported a change in its source, or copy attributes)</li>
<li>dirtyOutput (to render the cleaned input, or take account that the Loom paths’ cursors have changed)</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.stamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">force = false, host, changes</span>) </span>{

    <span class="hljs-keyword">if</span> (force) {

        <span class="hljs-keyword">if</span> (host &amp;&amp; host.type === <span class="hljs-string">'Cell'</span>) <span class="hljs-keyword">this</span>.currentHost = host;

        <span class="hljs-keyword">if</span> (changes) {

            <span class="hljs-keyword">this</span>.set(changes);
            <span class="hljs-keyword">this</span>.prepareStamp();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.regularStamp();
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.visibility) {

        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>,
            dirtyInput = <span class="hljs-keyword">this</span>.dirtyInput,
            dirtyOutput = <span class="hljs-keyword">this</span>.dirtyOutput;

        <span class="hljs-keyword">if</span> (dirtyInput) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

                self.cleanInput()
                .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {

                    self.sourceImageData = res;
                    <span class="hljs-keyword">return</span> self.cleanOutput();
                })
                .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {

                    self.output = res;
                    <span class="hljs-keyword">return</span> self.regularStamp();
                })
                .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {

                    resolve(<span class="hljs-literal">true</span>);
                })
                .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
                    
                    reject(err);
                });
            })
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dirtyOutput) {

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

                self.cleanOutput()
                .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {

                    self.output = res;
                    <span class="hljs-keyword">return</span> self.regularStamp();
                })
                .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {

                    resolve(<span class="hljs-literal">true</span>);
                })
                .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
                    
                    reject(err);
                });
            })
        }
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.regularStamp();
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-literal">false</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.cleanInput = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

        self.dirtyInput = <span class="hljs-literal">false</span>;

        self.setSourceDimension();

        <span class="hljs-keyword">let</span> sourceDimension = self.sourceDimension;

        <span class="hljs-keyword">if</span> (!sourceDimension) {

            self.dirtyInput = <span class="hljs-literal">true</span>;
            reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${self.name}</span> - cleanInput Error: source has a zero dimension`</span>));
        }

        <span class="hljs-keyword">let</span> cell = requestCell(),
            engine = cell.engine,
            canvas = cell.element;

        canvas.width = sourceDimension;
        canvas.height = sourceDimension;
        engine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

        self.source.stamp(<span class="hljs-literal">true</span>, cell, {
            <span class="hljs-attr">startX</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">startY</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">handleX</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">handleY</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">offsetX</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">offsetY</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">roll</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>,

            <span class="hljs-attr">width</span>: sourceDimension,
            <span class="hljs-attr">height</span>: sourceDimension,

            <span class="hljs-attr">method</span>: <span class="hljs-string">'fill'</span>,
        })
        .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {

            <span class="hljs-keyword">let</span> sourceImageData = engine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, sourceDimension, sourceDimension);

            releaseCell(cell);
            resolve(sourceImageData);
        })
        .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {

            releaseCell(cell);
            reject(err);
        });
    });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.cleanOutput = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    
    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

        self.dirtyOutput = <span class="hljs-literal">false</span>;

        self.setSourceDimension();
        
        <span class="hljs-keyword">let</span> sourceDimension = self.sourceDimension, 
            sourceData = self.sourceImageData;

        <span class="hljs-keyword">if</span> (sourceDimension &amp;&amp; sourceData) {

            <span class="hljs-keyword">let</span> mHypot = <span class="hljs-built_in">Math</span>.hypot,
                mFloor = <span class="hljs-built_in">Math</span>.floor,
                mCeil = <span class="hljs-built_in">Math</span>.ceil,
                mAtan2 = <span class="hljs-built_in">Math</span>.atan2,
                mCos = <span class="hljs-built_in">Math</span>.cos,
                mSin = <span class="hljs-built_in">Math</span>.sin;

            <span class="hljs-keyword">let</span> fromPathData = self.fromPathData,
                toPathData = self.toPathData,

                dataLen = fromPathData.length,

                fPathStart = self.fromPathStart,
                fCursor = fPathStart * dataLen,
                fStep = self.fromPathSteps || <span class="hljs-number">1</span>,

                tPathStart = self.toPathStart,
                tCursor = tPathStart * dataLen,
                tStep = self.toPathSteps || <span class="hljs-number">1</span>,

                magicHorizontalPi = <span class="hljs-number">0.5</span> * <span class="hljs-built_in">Math</span>.PI,
                magicVerticalPi = magicHorizontalPi - <span class="hljs-number">1.5708</span>,

                isHorizontalCopy = self.isHorizontalCopy,
                loop = self.loopPathCursors,

                fx, fy, tx, ty, dx, dy, dLength, dAngle, cos, sin, 

                watchFromPath = self.watchFromPath,
                watchIndex = self.watchIndex, 
                engineInstructions = self.engineInstructions,
                engineDeltaLengths = self.engineDeltaLengths,
                instruction;

            <span class="hljs-keyword">let</span> [startX, startY, outputWidth, outputHeight] = self.getBoundingBox();

            <span class="hljs-keyword">let</span> inputCell = requestCell(),
                inputEngine = inputCell.engine,
                inputCanvas = inputCell.element;

            inputCanvas.width = sourceDimension;
            inputCanvas.height = sourceDimension;
            inputEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            inputEngine.putImageData(sourceData, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

            <span class="hljs-keyword">let</span> outputCell = requestCell(),
                outputEngine = outputCell.engine,
                outputCanvas = outputCell.element;

            outputCanvas.width = outputWidth;
            outputCanvas.height = outputHeight;
            outputEngine.globalAlpha = self.state.globalAlpha;
            outputEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

            <span class="hljs-keyword">if</span>(!engineInstructions.length) {

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; sourceDimension; i++) {

                    <span class="hljs-keyword">if</span> (watchIndex &lt; <span class="hljs-number">0</span>) {

                        <span class="hljs-keyword">if</span> (watchFromPath &amp;&amp; fCursor &lt; <span class="hljs-number">1</span>) watchIndex = i;
                        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!watchFromPath &amp;&amp; tCursor &lt; <span class="hljs-number">1</span>) watchIndex = i;
                    }

                    <span class="hljs-keyword">if</span> (fCursor &lt; dataLen &amp;&amp; tCursor &lt; dataLen &amp;&amp; fCursor &gt;= <span class="hljs-number">0</span> &amp;&amp; tCursor &gt;= <span class="hljs-number">0</span>) {

                        [fx, fy] = fromPathData[mFloor(fCursor)];
                        [tx, ty] = toPathData[mFloor(tCursor)];

                        dx = tx - fx;
                        dy = ty - fy;

                        dLength = mHypot(dx, dy);

                        <span class="hljs-keyword">if</span> (isHorizontalCopy) {

                            dAngle = -mAtan2(dx, dy) + magicHorizontalPi;
                            cos = mCos(dAngle);
                            sin = mSin(dAngle);

                            engineInstructions.push([cos, sin, -sin, cos, fx, fy]);
                            engineDeltaLengths.push(dLength);
                        }
                        <span class="hljs-keyword">else</span> {

                            dAngle = -mAtan2(dx, dy) + magicVerticalPi;
                            cos = mCos(dAngle);
                            sin = mSin(dAngle);

                            engineInstructions.push([cos, sin, -sin, cos, fx, fy, dLength]);
                            engineDeltaLengths.push(dLength);
                        }
                    }
                    <span class="hljs-keyword">else</span> {

                        engineInstructions.push(<span class="hljs-literal">false</span>);
                        engineDeltaLengths.push(<span class="hljs-literal">false</span>);
                    }

                    fCursor += fStep;
                    tCursor += tStep;

                    <span class="hljs-keyword">if</span> (loop) {

                        <span class="hljs-keyword">if</span> (fCursor &gt;= dataLen) fCursor -= dataLen;
                        <span class="hljs-keyword">if</span> (tCursor &gt;= dataLen) tCursor -= dataLen;
                    }
                }
                <span class="hljs-keyword">if</span> (watchIndex &lt; <span class="hljs-number">0</span>) watchIndex = <span class="hljs-number">0</span>;
                self.watchIndex = watchIndex;
            }

            <span class="hljs-keyword">if</span> (isHorizontalCopy) {


                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; sourceDimension; i++) {

                    instruction = engineInstructions[watchIndex];

                    <span class="hljs-keyword">if</span> (instruction) {

                        outputEngine.setTransform(...instruction);
                        outputEngine.drawImage(inputCanvas, <span class="hljs-number">0</span>, watchIndex, sourceDimension, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, engineDeltaLengths[watchIndex], <span class="hljs-number">1</span>);
                    }
                    watchIndex++;

                    <span class="hljs-keyword">if</span> (watchIndex &gt;= sourceDimension) watchIndex = <span class="hljs-number">0</span>;
                }
            }
            <span class="hljs-keyword">else</span> {

                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; sourceDimension; i++) {

                    instruction = engineInstructions[watchIndex];

                    <span class="hljs-keyword">if</span> (instruction) {

                        outputEngine.setTransform(...instruction);
                        outputEngine.drawImage(inputCanvas, watchIndex, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, sourceDimension, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, engineDeltaLengths[watchIndex]);
                    }
                    watchIndex++;

                    <span class="hljs-keyword">if</span> (watchIndex &gt;= sourceDimension) watchIndex = <span class="hljs-number">0</span>;
                }
            }

            <span class="hljs-keyword">let</span> iFactor = self.interferenceFactor,
                iLoops = self.interferenceLoops,

                iWidth = mCeil(outputWidth * iFactor),
                iHeight = mCeil(outputHeight * iFactor);

            inputCanvas.width = iWidth;
            inputCanvas.height = iHeight;

            outputEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            inputEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; iLoops; j++) {

                inputEngine.drawImage(outputCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, outputWidth, outputHeight, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, iWidth, iHeight);
                outputEngine.drawImage(inputCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, iWidth, iHeight, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, outputWidth, outputHeight);
            }

            <span class="hljs-keyword">let</span> outputData = outputEngine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, outputWidth, outputHeight);

            releaseCell(inputCell);
            releaseCell(outputCell);

            self.dirtyTargetImage = <span class="hljs-literal">true</span>;

            resolve(outputData);
        }
        <span class="hljs-keyword">else</span> reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.name}</span> - cleanOutput Error: source has a zero dimension, or no data`</span>));
    });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.regularStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

        <span class="hljs-keyword">if</span> (self.currentHost) {

            self.regularStampSynchronousActions();
            resolve(<span class="hljs-literal">true</span>);
        }
        reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`<span class="hljs-subst">${self.name}</span> has no current host`</span>));
    });
};

P.regularStampSynchronousActions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> dest = <span class="hljs-keyword">this</span>.currentHost;

    <span class="hljs-keyword">if</span> (dest) {

        <span class="hljs-keyword">let</span> engine = dest.engine;

        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.noCanvasEngineUpdates) dest.setEngine(<span class="hljs-keyword">this</span>);

        <span class="hljs-keyword">this</span>[<span class="hljs-keyword">this</span>.method](engine);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Loom calculates its bounding box from the Shape path entitys associated with it</p>

            </div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>This function recalculates when presented with a <strong>dirtyStart</strong> flag - we rely on the Shape entitys to tell us when their paths have changed/updated</p>

            </div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Results get stashed in the <strong>boundingBox</strong> attribute for easier access, but all the method functions call this function just in case the box needs recalculating.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.getBoundingBox = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> fPath = <span class="hljs-keyword">this</span>.fromPath,
        tPath = <span class="hljs-keyword">this</span>.toPath;

    <span class="hljs-keyword">if</span>(fPath &amp;&amp; tPath) {

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyStart) {

            <span class="hljs-keyword">if</span> (fPath.getBoundingBox &amp;&amp; tPath.getBoundingBox) {

                <span class="hljs-keyword">this</span>.dirtyStart = <span class="hljs-literal">false</span>;

                <span class="hljs-keyword">let</span> [lsx, lsy, sw, sh, sx, sy] = fPath.getBoundingBox();
                <span class="hljs-keyword">let</span> [lex, ley, ew, eh, ex, ey] = tPath.getBoundingBox();

                lsx += sx;
                lsy += sy;
                lex += ex;
                ley += ey;

                <span class="hljs-keyword">let</span> minX = <span class="hljs-built_in">Math</span>.min(lsx, lex);
                <span class="hljs-keyword">let</span> maxX = <span class="hljs-built_in">Math</span>.max(lsx + sw, lex + ew);
                <span class="hljs-keyword">let</span> minY = <span class="hljs-built_in">Math</span>.min(lsy, ley);
                <span class="hljs-keyword">let</span> maxY = <span class="hljs-built_in">Math</span>.max(lsy + sh, ley + eh);

                <span class="hljs-keyword">this</span>.boundingBox = [minX, minY, maxX - minX, maxY - minY];

                <span class="hljs-keyword">this</span>.dirtyPathData = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.boundingBox = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>];
        }
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.boundingBox = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>];

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.boundingBox;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>These ‘method’ functions stamp the Loom entity onto the canvas context supplied to them in the <strong>engine</strong> argument</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.fill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{


    <span class="hljs-keyword">this</span>.doFill(engine);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.showBoundingBox) <span class="hljs-keyword">this</span>.drawBoundingBox(engine);

};

P.draw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">this</span>.doStroke(engine);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.showBoundingBox) <span class="hljs-keyword">this</span>.drawBoundingBox(engine);
};


P.drawAndFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">this</span>.doStroke(engine);
    <span class="hljs-keyword">this</span>.currentHost.clearShadow();
    <span class="hljs-keyword">this</span>.doFill(engine);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.showBoundingBox) <span class="hljs-keyword">this</span>.drawBoundingBox(engine);
};


P.fillAndDraw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">this</span>.doFill(engine);
    <span class="hljs-keyword">this</span>.currentHost.clearShadow();
    <span class="hljs-keyword">this</span>.doStroke(engine);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.showBoundingBox) <span class="hljs-keyword">this</span>.drawBoundingBox(engine);
};


P.drawThenFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">this</span>.doStroke(engine);
    <span class="hljs-keyword">this</span>.doFill(engine);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.showBoundingBox) <span class="hljs-keyword">this</span>.drawBoundingBox(engine);
};


P.fillThenDraw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">this</span>.doFill(engine);
    <span class="hljs-keyword">this</span>.doStroke(engine);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.showBoundingBox) <span class="hljs-keyword">this</span>.drawBoundingBox(engine);
};


P.clear = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">let</span> output = <span class="hljs-keyword">this</span>.output,
        canvas = (<span class="hljs-keyword">this</span>.currentHost) ? <span class="hljs-keyword">this</span>.currentHost.element : <span class="hljs-literal">false</span>,
        gco = engine.globalCompositeOperation;

    <span class="hljs-keyword">if</span> (output &amp;&amp; canvas) {

        <span class="hljs-keyword">let</span> tempCell = requestCell(),
            tempEngine = tempCell.engine,
            tempCanvas = tempCell.element;

        <span class="hljs-keyword">let</span> [x, y, w, h] = <span class="hljs-keyword">this</span>.getBoundingBox();

        tempCanvas.width = w;
        tempCanvas.height = h;

        tempEngine.putImageData(output, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        engine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        engine.globalCompositeOperation = <span class="hljs-string">'destination-out'</span>;
        engine.drawImage(tempCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h, x, y, w, h);
        engine.globalCompositeOperation = gco;

        releaseCell(tempCell);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.showBoundingBox) <span class="hljs-keyword">this</span>.drawBoundingBox(engine);
    }
};


P.none = defaultNonReturnFunction;</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>The stroke and fill functions handle most of the stuff that the ‘method’ functions require to stamp the Loom entity onto a canvas cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.doStroke = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">let</span> fPath = <span class="hljs-keyword">this</span>.fromPath,
        tPath = <span class="hljs-keyword">this</span>.toPath;

    <span class="hljs-keyword">if</span>(fPath &amp;&amp; fPath.getBoundingBox &amp;&amp; tPath &amp;&amp; tPath.getBoundingBox) {

        <span class="hljs-keyword">let</span> host = <span class="hljs-keyword">this</span>.currentHost;

        <span class="hljs-keyword">if</span> (host) {

            <span class="hljs-keyword">let</span> fStart = fPath.currentStampPosition,
                fEnd = fPath.currentEnd,
                tStart = tPath.currentStampPosition,
                tEnd = tPath.currentEnd;

            host.rotateDestination(engine, fStart[<span class="hljs-number">0</span>], fStart[<span class="hljs-number">1</span>], fPath);
            engine.stroke(fPath.pathObject);

            host.rotateDestination(engine, tStart[<span class="hljs-number">0</span>], tStart[<span class="hljs-number">1</span>], fPath);
            engine.stroke(tPath.pathObject);

            engine.setTransform(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            engine.beginPath()
            engine.moveTo(...fEnd);
            engine.lineTo(...tEnd);
            engine.moveTo(...tStart);
            engine.lineTo(...fStart);
            engine.closePath();
            engine.stroke();
        }
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>putImageData turns transparent pixels in the output, transparent in the host canvas - which is not what we want</p>

            </div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Problem solved by putting output into a pool cell, then drawing it from there to the host cell</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.doFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">let</span> output = <span class="hljs-keyword">this</span>.output,
        canvas = (<span class="hljs-keyword">this</span>.currentHost) ? <span class="hljs-keyword">this</span>.currentHost.element : <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (output &amp;&amp; canvas) {

        <span class="hljs-keyword">let</span> tempCell = requestCell(),
            tempEngine = tempCell.engine,
            tempCanvas = tempCell.element;

        <span class="hljs-keyword">let</span> [x, y, w, h] = <span class="hljs-keyword">this</span>.getBoundingBox();

        tempCanvas.width = w;
        tempCanvas.height = h;

        tempEngine.putImageData(output, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        engine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        engine.drawImage(tempCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h, x, y, w, h);

        releaseCell(tempCell);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Usually only need to draw the bounding box during development work, to make sure the getBoundingBox calculation is operating correctly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.drawBoundingBox = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyStart) <span class="hljs-keyword">this</span>.getBoundingBox();

    engine.save();

    <span class="hljs-keyword">let</span> t = engine.getTransform();
    engine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    engine.strokeStyle = <span class="hljs-keyword">this</span>.boundingBoxColor;
    engine.lineWidth = <span class="hljs-number">1</span>;
    engine.globalCompositeOperation = <span class="hljs-string">'source-over'</span>;
    engine.globalAlpha = <span class="hljs-number">1</span>;
    engine.shadowOffsetX = <span class="hljs-number">0</span>;
    engine.shadowOffsetY = <span class="hljs-number">0</span>;
    engine.shadowBlur = <span class="hljs-number">0</span>;

    engine.strokeRect(...this.boundingBox);

    engine.restore();
    engine.setTransform(t);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>The <strong>checkHit</strong> functionality can be used in the same way it is for other entitys (and groups)</p>

            </div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>One difference is that this function checks hits against an ImageData object, thus doesn’t need to be supplied with a pool canvas so that it can do its job</p>

            </div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>Note: will check for the <strong>dirtyTargetImage</strong> flag, which normally gets checked as part of the rendering cycle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.checkHit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = []</span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.noUserInteraction) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">let</span> tests = (!<span class="hljs-built_in">Array</span>.isArray(items)) ?  [items] : items,
        targetData = (<span class="hljs-keyword">this</span>.output &amp;&amp; <span class="hljs-keyword">this</span>.output.data) ? <span class="hljs-keyword">this</span>.output.data : <span class="hljs-literal">false</span>, 
        tx, ty, cx, cy, index;

    <span class="hljs-keyword">if</span> (targetData) {

        <span class="hljs-keyword">let</span> [x, y, w, h] = <span class="hljs-keyword">this</span>.getBoundingBox();

        <span class="hljs-keyword">if</span> (tests.some(<span class="hljs-function"><span class="hljs-params">test</span> =&gt;</span> {

            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(test)) {

                tx = test[<span class="hljs-number">0</span>];
                ty = test[<span class="hljs-number">1</span>];
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (xta(test, test.x, test.y)) {

                tx = test.x;
                ty = test.y;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

            <span class="hljs-keyword">if</span> (!tx.toFixed || !ty.toFixed || <span class="hljs-built_in">isNaN</span>(tx) || <span class="hljs-built_in">isNaN</span>(ty)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

            cx = tx - x;
            cy = ty - y;

            <span class="hljs-keyword">if</span> (cx &lt; <span class="hljs-number">0</span> || cx &gt; w || cy &lt; <span class="hljs-number">0</span> || cy &gt; h) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; 

            index = (((cy * w) + cx) * <span class="hljs-number">4</span>) + <span class="hljs-number">3</span>;

            <span class="hljs-keyword">if</span> (targetData) <span class="hljs-keyword">return</span> (targetData[index] &gt; <span class="hljs-number">0</span>) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        }, <span class="hljs-keyword">this</span>)) {

            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">x</span>: tx,
                <span class="hljs-attr">y</span>: ty,
                <span class="hljs-attr">artefact</span>: <span class="hljs-keyword">this</span>
            };
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <h2 id="exported-factory-function">Exported factory function</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> makeLoom = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Loom(items);
};

constructors.Loom = Loom;

<span class="hljs-keyword">export</span> {
    makeLoom,
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
