<!DOCTYPE html>

<html>
<head>
  <title>Group factory</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="../mixin/anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="../mixin/asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="../mixin/assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="../mixin/base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="../mixin/cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="../mixin/dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="../mixin/entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="../mixin/filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="../mixin/position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="../mixin/shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="../mixin/styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="../mixin/tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../worker/filter.html">
                  ./source/worker/filter.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="group-factory">Group factory</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h4 id="to-instantiate-objects-from-the-factory">To instantiate objects from the factory</h4>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h4 id="library-storage">Library storage</h4>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h4 id="clone-functionality">Clone functionality</h4>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h4 id="kill-functionality">Kill functionality</h4>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h2 id="imports">Imports</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> { constructors, cell, artefact, group, groupnames, entity } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/library.js'</span>;
<span class="hljs-keyword">import</span> { mergeOver, pushUnique, removeItem, xt } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/utilities.js'</span>;
<span class="hljs-keyword">import</span> { scrawlCanvasHold } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/document.js'</span>;

<span class="hljs-keyword">import</span> { requestFilterWorker, releaseFilterWorker, actionFilterWorker } <span class="hljs-keyword">from</span> <span class="hljs-string">'./filter.js'</span>;
<span class="hljs-keyword">import</span> { requestCell, releaseCell } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cell.js'</span>;
<span class="hljs-keyword">import</span> { importDomImage } <span class="hljs-keyword">from</span> <span class="hljs-string">'./imageAsset.js'</span>;

<span class="hljs-keyword">import</span> baseMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/base.js'</span>;
<span class="hljs-keyword">import</span> filterMix <span class="hljs-keyword">from</span> <span class="hljs-string">'../mixin/filter.js'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h2 id="group-constructor">Group constructor</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> Group = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">this</span>.makeName(items.name);
    <span class="hljs-keyword">this</span>.register();

    <span class="hljs-keyword">this</span>.artefacts = [];
    <span class="hljs-keyword">this</span>.artefactBuckets = [];

    <span class="hljs-keyword">this</span>.set(<span class="hljs-keyword">this</span>.defs);
    <span class="hljs-keyword">this</span>.set(items);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h2 id="group-object-prototype-setup">Group object prototype setup</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> P = Group.prototype = <span class="hljs-built_in">Object</span>.create(<span class="hljs-built_in">Object</span>.prototype);

P.type = <span class="hljs-string">'Group'</span>;
P.lib = <span class="hljs-string">'group'</span>;
P.isArtefact = <span class="hljs-literal">false</span>;
P.isAsset = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Apply mixins to prototype object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P = baseMix(P);
P = filterMix(P);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h2 id="define-default-attributes">Define default attributes</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    artefacts: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO: Do these need to be in the defs?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    artefactBuckets: <span class="hljs-literal">null</span>,

    <span class="hljs-attr">host</span>: <span class="hljs-string">''</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    order: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    visibility: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>TODO - does this need to be in the defs object?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    batchResort: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    regionRadius: <span class="hljs-number">0</span>
};
P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h2 id="packet-management">Packet management</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.packetExclusions = pushUnique(P.packetExclusions, [<span class="hljs-string">'artefactBuckets'</span>, <span class="hljs-string">'batchResort'</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="kill-functionality">Kill functionality</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.kill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">let</span> myname = <span class="hljs-keyword">this</span>.name;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Stack and canvas groups attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">Object</span>.entries(artefact).forEach(<span class="hljs-function">(<span class="hljs-params">[name, art]</span>) =&gt;</span> {

        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(art.groups) &amp;&amp; art.groups.indexOf(myname) &gt;= <span class="hljs-number">0</span>) removeItem(art.groups, myname);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Scrawl-canvas library</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.deregister();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2 id="define-attribute-getters-and-setters">Define attribute getters and setters</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">let</span> G = P.getters,
    S = P.setters;</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>G.artefacts = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">return</span> [].concat(<span class="hljs-keyword">this</span>.artefacts);
};
S.artefacts = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">this</span>.artefacts = [];

    <span class="hljs-keyword">this</span>.addArtefacts(item);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.host = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> host = <span class="hljs-keyword">this</span>.getHost(item);

    <span class="hljs-keyword">if</span> (host &amp;&amp; host.addGroups) {
        
        <span class="hljs-keyword">this</span>.host = item;
        host.addGroups(<span class="hljs-keyword">this</span>.name);

        <span class="hljs-keyword">this</span>.dirtyHost = <span class="hljs-literal">true</span>;
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>S.order = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> host = <span class="hljs-keyword">this</span>.getHost(<span class="hljs-keyword">this</span>.host);

    <span class="hljs-keyword">this</span>.order = item;

    <span class="hljs-keyword">if</span> (host) {

        host.set({
            <span class="hljs-attr">batchResort</span>: <span class="hljs-literal">true</span>
        });
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <h2 id="define-prototype-functions">Define prototype functions</h2>

            </div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.getHost = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

    <span class="hljs-keyword">let</span> host = <span class="hljs-keyword">this</span>.currentHost;

    <span class="hljs-keyword">if</span> (host &amp;&amp; item === host.name) <span class="hljs-keyword">return</span> host;
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> artefact[item] || cell[item] || <span class="hljs-literal">null</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.forceStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {

        <span class="hljs-keyword">let</span> v = self.visibility;
        self.visibility = <span class="hljs-literal">true</span>;

        self.stamp()
        .then(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
            self.visibility = v;
            resolve(res);
        })
        .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
            self.visibility = v;
            resolve(err);
        });
    });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>The Display Cycle is mediated through Groups - these Group functions control display functionality via a series of Promise cascades which in turn allow individual artefacts to make use of web workers, where appropriate, to achieve their stamping functionality - for example when they need to apply image filters to their output.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.stamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Check we have a host of some sort (either a Stack artefact or a Cell asset)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyHost || !<span class="hljs-keyword">this</span>.currentHost) {

        <span class="hljs-keyword">this</span>.dirtyHost = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> currentHost = <span class="hljs-keyword">this</span>.getHost(<span class="hljs-keyword">this</span>.host);

        <span class="hljs-keyword">if</span> (currentHost) <span class="hljs-keyword">this</span>.currentHost = currentHost;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">this</span>.dirtyHost = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

        <span class="hljs-keyword">if</span> (self.visibility) {

            <span class="hljs-keyword">let</span> currentHost = self.currentHost;

            <span class="hljs-keyword">if</span> (currentHost) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Check if artefacts need to be sorterd and, if yes, sort them by their order attribute</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                self.sortArtefacts();</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Check to see if there is a Group filter in place and, if yes, pull a Cell aset from the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">let</span> filterCell = (self.stashOutput || (!self.noFilters &amp;&amp; self.filters &amp;&amp; self.filters.length)) ?
                    requestCell() :
                    <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Setup the pool Cell, if required</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (filterCell &amp;&amp; filterCell.element) {

                    <span class="hljs-keyword">let</span> dims = currentHost.currentDimensions;

                    <span class="hljs-keyword">if</span> (dims) {

                        filterCell.element.width = dims[<span class="hljs-number">0</span>];
                        filterCell.element.height = dims[<span class="hljs-number">1</span>];
                    }
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Prepare the Group’s artefacts for the forthcoming stamp activity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                self.prepareStamp(filterCell);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Get the Group’s artefacts to stamp themselves on the current host</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                self.stampAction(filterCell)
                .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {

                    <span class="hljs-keyword">if</span> (filterCell) releaseCell(filterCell);
                    resolve(self.name);
                })
                .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {

                    <span class="hljs-keyword">if</span> (filterCell) releaseCell(filterCell);
                    reject(<span class="hljs-literal">false</span>)
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Bale out of the stamp functionality if the Group has no host on which to perform its actions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> resolve(<span class="hljs-literal">false</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Bale out of the stamp functionality if the Group is not visible</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> resolve(<span class="hljs-literal">false</span>);
    });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.sortArtefacts = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.batchResort) {

        <span class="hljs-keyword">this</span>.batchResort = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> floor = <span class="hljs-built_in">Math</span>.floor,
            buckets = [];
        
        <span class="hljs-keyword">this</span>.artefacts.forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {

            <span class="hljs-keyword">let</span> obj = artefact[name],
                order = floor(obj.order) || <span class="hljs-number">0</span>;

            <span class="hljs-keyword">if</span> (!buckets[order]) buckets[order] = [];

            buckets[order].push(obj);
        });

         <span class="hljs-keyword">this</span>.artefactBuckets = buckets.reduce(<span class="hljs-function">(<span class="hljs-params">a, v</span>) =&gt;</span> a.concat(v), []);
    }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.prepareStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">myCell</span>) </span>{

    <span class="hljs-keyword">let</span> host = <span class="hljs-keyword">this</span>.currentHost;

    <span class="hljs-keyword">if</span> (myCell) host = myCell;

    <span class="hljs-keyword">this</span>.artefactBuckets.forEach(<span class="hljs-function"><span class="hljs-params">art</span> =&gt;</span> {

        <span class="hljs-keyword">if</span> (art.lib === <span class="hljs-string">'entity'</span>) {
            
            <span class="hljs-keyword">if</span> (!art.currentHost || art.currentHost.name !== host.name) {

                art.currentHost = host;
                <span class="hljs-keyword">if</span> (!myCell) art.dirtyHost = <span class="hljs-literal">true</span>;
            }
        }

        <span class="hljs-keyword">if</span> (!art.noDeltaUpdates) art.updateByDelta();

        art.prepareStamp();
    });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.stampAction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">myCell</span>) </span>{

    <span class="hljs-keyword">let</span> mystash = (<span class="hljs-keyword">this</span>.currentHost &amp;&amp; <span class="hljs-keyword">this</span>.currentHost.stashOutput) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyFilters || !<span class="hljs-keyword">this</span>.currentFilters) <span class="hljs-keyword">this</span>.cleanFilters();

    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Doing it this way to ensure that each artefact completes its stamp action before the next one starts - performed as a promise so that if the artefact needs to filter its output it can use the (asynchronous) filter worker. This function is essentially a cascade of promises which collapse into resolution once all the artefacts have been actioned</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> next = <span class="hljs-function">(<span class="hljs-params">counter</span>) =&gt;</span> {

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

            <span class="hljs-keyword">let</span> art = self.artefactBuckets[counter];

            <span class="hljs-keyword">if</span> (art &amp;&amp; art.stamp) {

                art.stamp()
                .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {

                    next(counter + <span class="hljs-number">1</span>)
                    .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> resolve(<span class="hljs-literal">true</span>))
                    .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> reject(<span class="hljs-literal">false</span>));
                })
                .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> reject(<span class="hljs-literal">false</span>));
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>The else branch should only trigger once all the artefacts have been processed. At this point we should be okay to action any Group-level filters on the (entity) artefact output</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> {

                <span class="hljs-keyword">if</span> (myCell) {

                    <span class="hljs-keyword">if</span> (!self.noFilters &amp;&amp; self.filters &amp;&amp; self.filters.length) {

                        self.applyFilters(myCell)
                        .then(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> self.stashAction(img))
                        .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> resolve(<span class="hljs-literal">true</span>))
                        .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> reject(<span class="hljs-literal">false</span>));
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (self.stashOutput) {</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>We set up things to draw the group on a pool cell if stashOutput set true - so now we have to paint it back into the real canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">let</span> tempElement = myCell.element,
                            tempEngine = myCell.engine,
                            realEngine = (self.currentHost &amp;&amp; self.currentHost.engine) ? 
                                self.currentHost.engine : <span class="hljs-literal">false</span>;

                        <span class="hljs-keyword">if</span> (realEngine) {

                            realEngine.save();
                            
                            realEngine.globalCompositeOperation = <span class="hljs-string">'source-over'</span>;
                            realEngine.globalAlpha = <span class="hljs-number">1</span>;
                            realEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

                            realEngine.drawImage(tempElement, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                            
                            realEngine.restore();

                            <span class="hljs-keyword">let</span> tempImg = tempEngine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, tempElement.width, tempElement.height);

                            self.stashAction(tempImg)
                            .then(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> resolve(<span class="hljs-literal">true</span>))
                            .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> reject(<span class="hljs-literal">false</span>));
                        }
                        <span class="hljs-keyword">else</span> reject (<span class="hljs-string">'Could not find real engine'</span>);
                    }
                    <span class="hljs-keyword">else</span> resolve(<span class="hljs-literal">true</span>);
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Terminate the cascade and start the resolution collapse</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">else</span> resolve(<span class="hljs-literal">true</span>);
            }
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Start the artefact stamp cascade</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> next(<span class="hljs-number">0</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.applyFilters = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">myCell</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Clean and sort the Group-level filters before sending them to the filter worker for application</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Determine if we have all the required resources to perform the filter operation and, if not, clean up and resolve</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> currentHost = self.currentHost,
            filterHost = myCell;

        <span class="hljs-keyword">if</span> (!currentHost || !filterHost) reject(<span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>An internal cleanup function to release resources and restore the non-filter defaults to what they were before. It’s also in the cleanup phase that we (finally) copy over the results of the filter over to the current canvas display, taking into account the Group’s composite and alpha values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> cleanup = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

            releaseFilterWorker(worker);

            currentEngine.save();
            
            currentEngine.globalCompositeOperation = self.filterComposite;
            currentEngine.globalAlpha = self.filterAlpha;
            currentEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

            currentEngine.drawImage(filterElement, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            
            currentEngine.restore();
        };</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Get handles to current and filter cell elements and engines</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">let</span> currentElement = currentHost.element,
            currentEngine = currentHost.engine;

        <span class="hljs-keyword">let</span> filterElement = filterHost.element,
            filterEngine = filterHost.engine;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Action a request to use the filtered artefacts as a stencil</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (self.isStencil) {
            
            filterEngine.save();
            filterEngine.globalCompositeOperation = <span class="hljs-string">'source-in'</span>;
            filterEngine.globalAlpha = <span class="hljs-number">1</span>;
            filterEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            filterEngine.drawImage(currentElement, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            filterEngine.restore();
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>At this point we will send the contents of the filterHost canvas over to the web worker, alongside details of the filters we wish to apply to it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        filterEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

        <span class="hljs-keyword">let</span> myimage = filterEngine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, filterElement.width, filterElement.height),
            worker = requestFilterWorker();

        actionFilterWorker(worker, {
            <span class="hljs-attr">image</span>: myimage,
            <span class="hljs-attr">filters</span>: self.currentFilters,
        })
        .then(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Copy the filter worker’s output back onto the filterHost canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (img) {

                filterEngine.globalCompositeOperation = <span class="hljs-string">'source-over'</span>;
                filterEngine.globalAlpha = <span class="hljs-number">1</span>;
                filterEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                filterEngine.putImageData(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>On success, cleanup and resolve</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                cleanup();
                resolve(img);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'image issue'</span>);
        })
        .catch(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {

            cleanup();
            reject(<span class="hljs-literal">false</span>);
        });
    });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Internal function - creates an imageAsset object (and an &lt;img&gt; element which gets attached to the DOM document in the scrawlCanvasHold hidden &lt;div&gt; element) from the group’s entity’s output.</p>

            </div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Note that, unlike the equivalent functionality for Cell and entity objects, the Group stashAction functionality seems to be working fine in “real time”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.stashAction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">img</span>) </span>{

    <span class="hljs-keyword">if</span> (!img) <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(<span class="hljs-string">'No image data supplied to stashAction'</span>);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.stashOutput) {

        <span class="hljs-keyword">this</span>.stashOutput = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span> (<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

            <span class="hljs-keyword">let</span> [x, y, width, height] = self.getCellCoverage(img);

            <span class="hljs-keyword">let</span> myCell = requestCell(),
                myEngine = myCell.engine,
                myElement = myCell.element;

            myElement.width = width;
            myElement.height = height;

            myEngine.putImageData(img, -x, -y);

            self.stashedImageData = myEngine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);

            <span class="hljs-keyword">if</span> (self.stashOutputAsAsset) {

                self.stashOutputAsAsset = <span class="hljs-literal">false</span>;

                <span class="hljs-keyword">if</span> (!self.stashedImage) {

                    <span class="hljs-keyword">let</span> newimg = self.stashedImage = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>);

                    newimg.id = <span class="hljs-string">`<span class="hljs-subst">${self.name}</span>-groupimage`</span>;

                    newimg.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                        scrawlCanvasHold.appendChild(newimg);
                        importDomImage(<span class="hljs-string">`#<span class="hljs-subst">${newimg.id}</span>`</span>);
                    };

                    newimg.src = myElement.toDataURL();
                }
                <span class="hljs-keyword">else</span> self.stashedImage.src = myElement.toDataURL();
            }
            releaseCell(myCell);

            resolve(<span class="hljs-literal">true</span>);
        });
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-literal">false</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.getCellCoverage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">img</span>) </span>{

    <span class="hljs-keyword">let</span> width = img.width,
        height = img.height,
        data = img.data,
        maxX = <span class="hljs-number">0</span>,
        maxY = <span class="hljs-number">0</span>,
        minX = width,
        minY = height,
        counter = <span class="hljs-number">3</span>,
        x, y;

    <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; height; y++) {

        <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; width; x++) {

            <span class="hljs-keyword">if</span> (data[counter]) {

                <span class="hljs-keyword">if</span> (minX &gt; x) minX = x;
                <span class="hljs-keyword">if</span> (maxX &lt; x) maxX = x;
                <span class="hljs-keyword">if</span> (minY &gt; y) minY = y;
                <span class="hljs-keyword">if</span> (maxY &lt; y) maxY = y;
            }

            counter += <span class="hljs-number">4</span>;
        }
    }
    <span class="hljs-keyword">if</span> (minX &lt; maxX &amp;&amp; minY &lt; maxY) <span class="hljs-keyword">return</span> [minX, minY, maxX - minX, maxY - minY];
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height];
};</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Artefacts should be added to, and removed from, the group object using the <strong>addArtefacts</strong> and <strong>removeArtefacts</strong> functions. The argument can be one or more artefact object’s name attribute, or the artefact object(s) itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.addArtefacts = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) </span>{

    <span class="hljs-keyword">if</span> (args &amp;&amp; <span class="hljs-built_in">Array</span>.isArray(args[<span class="hljs-number">0</span>])) args = args[<span class="hljs-number">0</span>];

    args.forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {

        <span class="hljs-keyword">if</span> (item) {

            <span class="hljs-keyword">if</span> (item.substring) pushUnique(<span class="hljs-keyword">this</span>.artefacts, item);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.name) pushUnique(<span class="hljs-keyword">this</span>.artefacts, item.name);
        }
    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.batchResort = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

P.removeArtefacts = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) </span>{

    args.forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {

        <span class="hljs-keyword">if</span> (item) {

            <span class="hljs-keyword">if</span> (item.substring) removeItem(<span class="hljs-keyword">this</span>.artefacts, item);
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.name) removeItem(<span class="hljs-keyword">this</span>.artefacts, item.name);
        }
    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.batchResort = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

P.clearArtefacts = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">this</span>.artefacts.length = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.artefactBuckets.length = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.batchResort = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.moveArtefactsIntoGroup = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) </span>{

    args.forEach(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {

        <span class="hljs-keyword">if</span> (item) {

            <span class="hljs-keyword">let</span> temp;

            <span class="hljs-keyword">if</span> (item.substring) {

                temp = group[artefact[item].group];

                <span class="hljs-keyword">if</span> (temp) temp.removeArtefacts(item);

                pushUnique(<span class="hljs-keyword">this</span>.artefacts, item);
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item.name) {

                temp = group[item.group];

                <span class="hljs-keyword">if</span> (temp) temp.removeArtefacts(item.name);

                pushUnique(<span class="hljs-keyword">this</span>.artefacts, item.name);
            }
        }
    }, <span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.batchResort = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Update all artefact objects using the <strong>updateArtefacts</strong> function. The supplied argument will be passed on to each artefact’s <em>setDelta</em> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.updateArtefacts = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

    <span class="hljs-keyword">this</span>.cascadeAction(items, <span class="hljs-string">'setDelta'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Set all artefact objects using the <strong>setArtefacts</strong> function. The supplied argument will be passed on to each artefact’s <em>set</em> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.setArtefacts = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

    <span class="hljs-keyword">this</span>.cascadeAction(items, <span class="hljs-string">'set'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.updateByDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">this</span>.cascadeAction(<span class="hljs-literal">false</span>, <span class="hljs-string">'updateByDelta'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

P.reverseByDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">this</span>.cascadeAction(<span class="hljs-literal">false</span>, <span class="hljs-string">'reverseByDelta'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.addArtefactClasses = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

    <span class="hljs-keyword">this</span>.cascadeAction(items, <span class="hljs-string">'addClasses'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

P.removeArtefactClasses = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

    <span class="hljs-keyword">this</span>.cascadeAction(items, <span class="hljs-string">'removeClasses'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.cascadeAction = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items, action</span>) </span>{

    <span class="hljs-keyword">this</span>.artefacts.forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {

        <span class="hljs-keyword">let</span> art = artefact[name];
        
        <span class="hljs-keyword">if</span>(art &amp;&amp; art[action]) art[action](items);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.setDeltaValues = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

    <span class="hljs-keyword">this</span>.artefactBuckets.forEach(<span class="hljs-function"><span class="hljs-params">art</span> =&gt;</span> art.setDeltaValues(items));

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.addFiltersToEntitys = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) </span>{

    <span class="hljs-keyword">this</span>.artefacts.forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {

        <span class="hljs-keyword">let</span> ent = entity[name];
        
        <span class="hljs-keyword">if</span> (ent &amp;&amp; ent.addFilters) ent.addFilters(args);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

P.removeFiltersFromEntitys = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) </span>{

    <span class="hljs-keyword">this</span>.artefacts.forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {

        <span class="hljs-keyword">let</span> ent = entity[name];

        <span class="hljs-keyword">if</span> (ent &amp;&amp; ent.removeFilters) ent.removeFilters(args);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};

P.clearFiltersFromEntitys = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">this</span>.artefacts.forEach(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> {

        <span class="hljs-keyword">let</span> ent = entity[name];

        <span class="hljs-keyword">if</span> (ent &amp;&amp; ent.clearFilters) ent.clearFilters();
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>The <strong>getArtefactAt</strong> function checks to see if any of the group object’s artefacts are located at the supplied coordinates in the argument object. </p>

            </div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>The hit report from the first artefact to respond back positively (artefacts with the highest order value are checked first) will be returned by the function. </p>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Where no artefacts are present at that coordinate the function returns false.</p>

            </div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>A <strong>hit report</strong> is a Javascript object with the following attributes:</p>

            </div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <ul>
<li>.x - the x coordinate supplied in this functions argument object</li>
<li>.y - the y coordinate supplied in this functions argument object</li>
<li>.artefact - the Scrawl-canvas artefact object reporting the hit</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>This function forms part of the Scrawl-canvas library’s <strong>drag-and-drop</strong> functionality.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.getArtefactAt = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

    <span class="hljs-keyword">let</span> myCell = requestCell(),
        artBuckets = <span class="hljs-keyword">this</span>.artefactBuckets;

    <span class="hljs-keyword">this</span>.sortArtefacts();

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = artBuckets.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {

        <span class="hljs-keyword">let</span> art = artBuckets[i];
        
        <span class="hljs-keyword">if</span> (art) {

            <span class="hljs-keyword">let</span> result = art.checkHit(items, myCell);

            <span class="hljs-keyword">if</span> (result) {

                releaseCell(myCell);
                <span class="hljs-keyword">return</span> result;
            }
        }
    }

    releaseCell(myCell);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>The <strong>getAllArtefactsAt</strong> function returns an array of hit reports from all of the group object’s artefacts located at the supplied coordinates in the argument object. The artefact with the highest order attribute value will be returned first in the response array.</p>

            </div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>The function will always return an array of hit reports, or an empty array if no hits are reported.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.getAllArtefactsAt = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

    <span class="hljs-keyword">let</span> myCell = requestCell(),
        artBuckets = <span class="hljs-keyword">this</span>.artefactBuckets,
        resultNames = [],
        results = [];

    <span class="hljs-keyword">this</span>.sortArtefacts();
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = artBuckets.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {

        <span class="hljs-keyword">let</span> art = artBuckets[i];
        
        <span class="hljs-keyword">if</span> (art) {

            <span class="hljs-keyword">let</span> result = art.checkHit(items, myCell);
            
            <span class="hljs-keyword">if</span> (result &amp;&amp; result.artefact) {

                <span class="hljs-keyword">let</span> hit = result.artefact;

                <span class="hljs-keyword">if</span> (resultNames.indexOf(hit.name) &lt; <span class="hljs-number">0</span>) {

                    resultNames.push(hit.name);
                    results.push(result);
                }
            }
        }
    }

    releaseCell(myCell);
    <span class="hljs-keyword">return</span> results;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>The <strong>getArtefactCollisions</strong> function returns an array of hit reports from all of the group object’s artefacts which are currently in collision with the <strong>sensor</strong> coordinates supplied by the artefact argument. The function will always return an array of hit reports, or an empty array if no hits are reported.</p>

            </div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>The argument must be either the artefact object itself, or its String name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>P.getArtefactCollisions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">art</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>return empty array if no argument, or the argument is not an artefact, or the group is empty</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!art || !art.isArtefact || !<span class="hljs-keyword">this</span>.artefactBuckets.length) <span class="hljs-keyword">return</span> [];

    <span class="hljs-keyword">if</span> (art.substring) art = artefact[art];</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Return empty array if the artefact argument has not been setup to check for collisions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!art.collides) <span class="hljs-keyword">return</span> [];

    <span class="hljs-keyword">let</span> artBuckets = <span class="hljs-keyword">this</span>.artefactBuckets,
        targets = [],
        target, i, iz;</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Get entity collision data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> [entityRadius, entitySensors] = art.cleanCollisionData();</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Winnow step 1: don’t check the entity itself, or any missing or malformed artefacts in the group</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = artBuckets.length; i &lt; iz; i++) {

        target = artBuckets[i];

        <span class="hljs-keyword">if</span> (!target || !target.cleanCollisionData || art.name === target.name) targets.push(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">else</span> targets.push(target);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Winnow step 2: exclude all targets outside the artefact/target collision radius</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> [entityStampX, entityStampY] = art.currentStampPosition;

    <span class="hljs-keyword">let</span> combinedRadius, targetData, dx, dy, dh;

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = targets.length; i &lt; iz; i++) {

        target = targets[i];

        <span class="hljs-keyword">if</span> (target) {

            <span class="hljs-keyword">let</span> [targetStampX, targetStampY] = target.currentStampPosition;

            targetData = target.cleanCollisionData();
            combinedRadius = entityRadius + targetData[<span class="hljs-number">0</span>];

            dx = entityStampX - targetStampX;
            dy = entityStampY - targetStampY;
            dh = <span class="hljs-built_in">Math</span>.sqrt((dx * dx) + (dy * dy));

            <span class="hljs-keyword">if</span> (dh &gt; combinedRadius) targets[i] = <span class="hljs-literal">false</span>;
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Winnow step 3: perform hit checks on remaining targets - this will not retrieve targets entirely inside the artefact</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> myCell = requestCell();

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, iz = targets.length; i &lt; iz; i++) {

        target = targets[i];

        <span class="hljs-keyword">if</span> (target) targets[i] = target.checkHit(entitySensors, myCell);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>return filtered results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    releaseCell(myCell);

    <span class="hljs-keyword">return</span> targets.filter(<span class="hljs-function"><span class="hljs-params">target</span> =&gt;</span> !!target);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <h2 id="exported-factory-function">Exported factory function</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> makeGroup = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items</span>) </span>{

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Group(items);
};

constructors.Group = Group;

<span class="hljs-keyword">export</span> {
    makeGroup,
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
