<!DOCTYPE html>

<html>
<head>
  <title>Entity mixin</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../core/animationloop.html">
                  ./source/core/animationloop.js
                </a>
              
                
                <a class="source" href="../core/component.html">
                  ./source/core/component.js
                </a>
              
                
                <a class="source" href="../core/document.html">
                  ./source/core/document.js
                </a>
              
                
                <a class="source" href="../core/init.html">
                  ./source/core/init.js
                </a>
              
                
                <a class="source" href="../core/library.html">
                  ./source/core/library.js
                </a>
              
                
                <a class="source" href="../core/userInteraction.html">
                  ./source/core/userInteraction.js
                </a>
              
                
                <a class="source" href="../core/utilities.html">
                  ./source/core/utilities.js
                </a>
              
                
                <a class="source" href="../factory/action.html">
                  ./source/factory/action.js
                </a>
              
                
                <a class="source" href="../factory/anchor.html">
                  ./source/factory/anchor.js
                </a>
              
                
                <a class="source" href="../factory/animation.html">
                  ./source/factory/animation.js
                </a>
              
                
                <a class="source" href="../factory/block.html">
                  ./source/factory/block.js
                </a>
              
                
                <a class="source" href="../factory/canvas.html">
                  ./source/factory/canvas.js
                </a>
              
                
                <a class="source" href="../factory/cell.html">
                  ./source/factory/cell.js
                </a>
              
                
                <a class="source" href="../factory/color.html">
                  ./source/factory/color.js
                </a>
              
                
                <a class="source" href="../factory/coordinate.html">
                  ./source/factory/coordinate.js
                </a>
              
                
                <a class="source" href="../factory/element.html">
                  ./source/factory/element.js
                </a>
              
                
                <a class="source" href="../factory/filter.html">
                  ./source/factory/filter.js
                </a>
              
                
                <a class="source" href="../factory/fontAttributes.html">
                  ./source/factory/fontAttributes.js
                </a>
              
                
                <a class="source" href="../factory/gradient.html">
                  ./source/factory/gradient.js
                </a>
              
                
                <a class="source" href="../factory/grid.html">
                  ./source/factory/grid.js
                </a>
              
                
                <a class="source" href="../factory/group.html">
                  ./source/factory/group.js
                </a>
              
                
                <a class="source" href="../factory/imageAsset.html">
                  ./source/factory/imageAsset.js
                </a>
              
                
                <a class="source" href="../factory/loom.html">
                  ./source/factory/loom.js
                </a>
              
                
                <a class="source" href="../factory/palette.html">
                  ./source/factory/palette.js
                </a>
              
                
                <a class="source" href="../factory/pattern.html">
                  ./source/factory/pattern.js
                </a>
              
                
                <a class="source" href="../factory/phrase.html">
                  ./source/factory/phrase.js
                </a>
              
                
                <a class="source" href="../factory/picture.html">
                  ./source/factory/picture.js
                </a>
              
                
                <a class="source" href="../factory/quaternion.html">
                  ./source/factory/quaternion.js
                </a>
              
                
                <a class="source" href="../factory/radialGradient.html">
                  ./source/factory/radialGradient.js
                </a>
              
                
                <a class="source" href="../factory/renderAnimation.html">
                  ./source/factory/renderAnimation.js
                </a>
              
                
                <a class="source" href="../factory/shape.html">
                  ./source/factory/shape.js
                </a>
              
                
                <a class="source" href="../factory/spriteAsset.html">
                  ./source/factory/spriteAsset.js
                </a>
              
                
                <a class="source" href="../factory/stack.html">
                  ./source/factory/stack.js
                </a>
              
                
                <a class="source" href="../factory/state.html">
                  ./source/factory/state.js
                </a>
              
                
                <a class="source" href="../factory/ticker.html">
                  ./source/factory/ticker.js
                </a>
              
                
                <a class="source" href="../factory/tween.html">
                  ./source/factory/tween.js
                </a>
              
                
                <a class="source" href="../factory/unstackedElement.html">
                  ./source/factory/unstackedElement.js
                </a>
              
                
                <a class="source" href="../factory/vector.html">
                  ./source/factory/vector.js
                </a>
              
                
                <a class="source" href="../factory/videoAsset.html">
                  ./source/factory/videoAsset.js
                </a>
              
                
                <a class="source" href="../factory/wheel.html">
                  ./source/factory/wheel.js
                </a>
              
                
                <a class="source" href="anchor.html">
                  ./source/mixin/anchor.js
                </a>
              
                
                <a class="source" href="asset.html">
                  ./source/mixin/asset.js
                </a>
              
                
                <a class="source" href="assetConsumer.html">
                  ./source/mixin/assetConsumer.js
                </a>
              
                
                <a class="source" href="base.html">
                  ./source/mixin/base.js
                </a>
              
                
                <a class="source" href="cascade.html">
                  ./source/mixin/cascade.js
                </a>
              
                
                <a class="source" href="dom.html">
                  ./source/mixin/dom.js
                </a>
              
                
                <a class="source" href="entity.html">
                  ./source/mixin/entity.js
                </a>
              
                
                <a class="source" href="filter.html">
                  ./source/mixin/filter.js
                </a>
              
                
                <a class="source" href="position.html">
                  ./source/mixin/position.js
                </a>
              
                
                <a class="source" href="shapePathCalculation.html">
                  ./source/mixin/shapePathCalculation.js
                </a>
              
                
                <a class="source" href="styles.html">
                  ./source/mixin/styles.js
                </a>
              
                
                <a class="source" href="tween.html">
                  ./source/mixin/tween.js
                </a>
              
                
                <a class="source" href="../worker/filter.html">
                  ./source/worker/filter.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="entity-mixin">Entity mixin</h1>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>This mixin builds on the <em>base</em> mixin to set up much of the basic functionality of a Scrawl-canvas <strong>entity</strong> Object:</p>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <ul>
<li><strong>defaults</strong> -</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <ul>
<li><strong>getters</strong> -</li>
<li><strong>setters</strong> -</li>
<li><strong>deltaSetters</strong> - </li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2 id="imports">Imports</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> library <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/library.js'</span>;
<span class="hljs-keyword">import</span> { defaultNonReturnFunction, defaultThisReturnFunction, defaultFalseReturnFunction, 
    generateUuid, isa_fn, mergeOver, pushUnique, xt, xta, addStrings } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/utilities.js'</span>;
<span class="hljs-keyword">import</span> { currentGroup, scrawlCanvasHold } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/document.js'</span>;
<span class="hljs-keyword">import</span> { currentCorePosition } <span class="hljs-keyword">from</span> <span class="hljs-string">'../core/userInteraction.js'</span>;

<span class="hljs-keyword">import</span> { makeState } <span class="hljs-keyword">from</span> <span class="hljs-string">'../factory/state.js'</span>;
<span class="hljs-keyword">import</span> { requestCell, releaseCell } <span class="hljs-keyword">from</span> <span class="hljs-string">'../factory/cell.js'</span>;
<span class="hljs-keyword">import</span> { requestFilterWorker, releaseFilterWorker, actionFilterWorker } <span class="hljs-keyword">from</span> <span class="hljs-string">'../factory/filter.js'</span>;
<span class="hljs-keyword">import</span> { importDomImage } <span class="hljs-keyword">from</span> <span class="hljs-string">'../factory/imageAsset.js'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">P = {}</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h2 id="define-attributes">Define attributes</h2>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>All factories using the position mixin will add these to their prototype objects</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> defaultAttributes = {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        method: <span class="hljs-string">'fill'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        pathObject: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        winding: <span class="hljs-string">'nonzero'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        flipReverse: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">flipUpend</span>: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        scaleOutline: <span class="hljs-literal">true</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        lockFillStyleToEntity: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">lockStrokeStyleToEntity</span>: <span class="hljs-literal">false</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        onEnter: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onLeave</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onDown</span>: <span class="hljs-literal">null</span>,
        <span class="hljs-attr">onUp</span>: <span class="hljs-literal">null</span>,
    };
    P.defs = mergeOver(P.defs, defaultAttributes);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h2 id="packet-management">Packet management</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.packetExclusions = pushUnique(P.packetExclusions, [<span class="hljs-string">'state'</span>]);
    P.packetExclusionsByRegex = pushUnique(P.packetExclusionsByRegex, []);
    P.packetCoordinates = pushUnique(P.packetCoordinates, []);
    P.packetObjects = pushUnique(P.packetObjects, []);
    P.packetFunctions = pushUnique(P.packetFunctions, [<span class="hljs-string">'onEnter'</span>, <span class="hljs-string">'onLeave'</span>, <span class="hljs-string">'onDown'</span>, <span class="hljs-string">'onUp'</span>]);

    P.processEntityPacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, includes</span>) </span>{

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.processFactoryPacketOut(key, value, includes);
    };

    P.processFactoryPacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key, value, includes</span>) </span>{

        <span class="hljs-keyword">let</span> result = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span>(includes.indexOf(key) &lt; <span class="hljs-number">0</span> &amp;&amp; value === <span class="hljs-keyword">this</span>.defs[key]) result = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">return</span> result;
    };

    P.finalizePacketOut = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">copy, items</span>) </span>{

        <span class="hljs-keyword">let</span> stateCopy = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.state.saveAsPacket(items))[<span class="hljs-number">3</span>];
        copy = mergeOver(copy, stateCopy);

        copy = <span class="hljs-keyword">this</span>.handlePacketAnchor(copy, items);

        <span class="hljs-keyword">return</span> copy;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Overwrites postCloneAction function in mixin/base.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.postCloneAction = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">clone, items</span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.onEnter) clone.onEnter = <span class="hljs-keyword">this</span>.onEnter;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.onLeave) clone.onLeave = <span class="hljs-keyword">this</span>.onLeave;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.onDown) clone.onDown = <span class="hljs-keyword">this</span>.onDown;
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.onUp) clone.onUp = <span class="hljs-keyword">this</span>.onUp;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Shared state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (items.sharedState) clone.state = <span class="hljs-keyword">this</span>.state;</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Cloned anchors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (items.anchor) {

            items.anchor.host = clone;

            <span class="hljs-keyword">if</span> (!xt(items.anchor.focusAction)) items.anchor.focusAction = <span class="hljs-keyword">this</span>.anchor.focusAction;
            <span class="hljs-keyword">if</span> (!xt(items.anchor.blurAction)) items.anchor.blurAction = <span class="hljs-keyword">this</span>.anchor.blurAction;

            clone.buildAnchor(items.anchor);

            <span class="hljs-keyword">if</span> (!items.anchor.clickAction) clone.anchor.clickAction = <span class="hljs-keyword">this</span>.anchor.clickAction;
        }

        <span class="hljs-keyword">return</span> clone;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <h2 id="define-getter-setter-and-deltasetter-functions">Define getter, setter and deltaSetter functions</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> G = P.getters,
        S = P.setters,
        D = P.deltaSetters;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    G.group = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">this</span>.group) ? <span class="hljs-keyword">this</span>.group.name : <span class="hljs-string">''</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.lockStylesToEntity = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">this</span>.lockFillStyleToEntity = item;
        <span class="hljs-keyword">this</span>.lockStrokeStyleToEntity = item;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    S.flipUpend = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">if</span> (item !== <span class="hljs-keyword">this</span>.flipUpend) <span class="hljs-keyword">this</span>.dirtyCollision = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.flipUpend = item;
    };

    S.flipReverse = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">if</span> (item !== <span class="hljs-keyword">this</span>.flipReverse) <span class="hljs-keyword">this</span>.dirtyCollision = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.flipReverse = item;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h2 id="define-functions-to-be-added-to-the-factory-prototype">Define functions to be added to the factory prototype</h2>

            </div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Overwrites function defined in mixin/base.js - takes into account State object attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.get = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">item</span>) </span>{

        <span class="hljs-keyword">let</span> getter = <span class="hljs-keyword">this</span>.getters[item];

        <span class="hljs-keyword">if</span> (getter) <span class="hljs-keyword">return</span> getter.call(<span class="hljs-keyword">this</span>);

        <span class="hljs-keyword">else</span> {

            <span class="hljs-keyword">let</span> def = <span class="hljs-keyword">this</span>.defs[item],
                state = <span class="hljs-keyword">this</span>.state,
                val;

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def != <span class="hljs-string">'undefined'</span>) {

                val = <span class="hljs-keyword">this</span>[item];
                <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val != <span class="hljs-string">'undefined'</span>) ? val : def;
            }

            def = state.defs[item];

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> def != <span class="hljs-string">'undefined'</span>) {

                val = state[item];
                <span class="hljs-keyword">return</span> (<span class="hljs-keyword">typeof</span> val != <span class="hljs-string">'undefined'</span>) ? val : def;
            }
            <span class="hljs-keyword">return</span> undef;
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Overwrites function defined in mixin/base.js - takes into account State object attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.set = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">if</span> (items) {

            <span class="hljs-keyword">let</span> setters = <span class="hljs-keyword">this</span>.setters,
                defs = <span class="hljs-keyword">this</span>.defs,
                state = <span class="hljs-keyword">this</span>.state,
                stateSetters = (state) ? state.setters : {},
                stateDefs = (state) ? state.defs : {};

            <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

                <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">'name'</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                    <span class="hljs-keyword">let</span> predefined = setters[key],
                        stateFlag = <span class="hljs-literal">false</span>;

                    <span class="hljs-keyword">if</span> (!predefined) {

                        predefined = stateSetters[key];
                        stateFlag = <span class="hljs-literal">true</span>;
                    }

                    <span class="hljs-keyword">if</span> (predefined) predefined.call(stateFlag ? <span class="hljs-keyword">this</span>.state : <span class="hljs-keyword">this</span>, value);
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] !== <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">this</span>[key] = value;
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> stateDefs[key] !== <span class="hljs-string">'undefined'</span>) state[key] = value;
                }
            }, <span class="hljs-keyword">this</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Overwrites function defined in mixin/base.js - takes into account State object attributes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.setDelta = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">if</span> (items) {

            <span class="hljs-keyword">let</span> setters = <span class="hljs-keyword">this</span>.deltaSetters,
                defs = <span class="hljs-keyword">this</span>.defs,
                state = <span class="hljs-keyword">this</span>.state,
                stateSetters = (state) ? state.deltaSetters : {},
                stateDefs = (state) ? state.defs : {};

            <span class="hljs-built_in">Object</span>.entries(items).forEach(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {

                <span class="hljs-keyword">if</span> (key &amp;&amp; key !== <span class="hljs-string">'name'</span> &amp;&amp; value != <span class="hljs-literal">null</span>) {

                    <span class="hljs-keyword">let</span> predefined = setters[key],
                        stateFlag = <span class="hljs-literal">false</span>;

                    <span class="hljs-keyword">if</span> (!predefined) {

                        predefined = stateSetters[key];
                        stateFlag = <span class="hljs-literal">true</span>;
                    }

                    <span class="hljs-keyword">if</span> (predefined) predefined.call(stateFlag ? <span class="hljs-keyword">this</span>.state : <span class="hljs-keyword">this</span>, value);
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> defs[key] !== <span class="hljs-string">'undefined'</span>) <span class="hljs-keyword">this</span>[key] = addStrings(<span class="hljs-keyword">this</span>[key], value);
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> stateDefs[key] !== <span class="hljs-string">'undefined'</span>) state[key] = addStrings(state[key], value);
                }
            }, <span class="hljs-keyword">this</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.entityInit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">items = {}</span>) </span>{

        <span class="hljs-keyword">this</span>.makeName(items.name);
        <span class="hljs-keyword">this</span>.register();
        <span class="hljs-keyword">this</span>.initializePositions();

        <span class="hljs-keyword">this</span>.set(<span class="hljs-keyword">this</span>.defs);

        <span class="hljs-keyword">this</span>.state = makeState();

        <span class="hljs-keyword">if</span> (!items.group) items.group = currentGroup;

        <span class="hljs-keyword">this</span>.onEnter = defaultNonReturnFunction;
        <span class="hljs-keyword">this</span>.onLeave = defaultNonReturnFunction;
        <span class="hljs-keyword">this</span>.onDown = defaultNonReturnFunction;
        <span class="hljs-keyword">this</span>.onUp = defaultNonReturnFunction;

        <span class="hljs-keyword">this</span>.set(items);

        <span class="hljs-keyword">this</span>.midInitActions(items);
    };

    P.midInitActions = defaultNonReturnFunction;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>CURRENTLY does not support filters on entitys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.simpleStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">host, changes = {}</span>) </span>{

        <span class="hljs-keyword">if</span> (host &amp;&amp; host.type === <span class="hljs-string">'Cell'</span>) {

            <span class="hljs-keyword">this</span>.currentHost = host;
            
            <span class="hljs-keyword">this</span>.set(changes);
            <span class="hljs-keyword">this</span>.prepareStamp();

            <span class="hljs-keyword">this</span>.regularStampSynchronousActions();
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.prepareStamp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyHost) {

            <span class="hljs-keyword">this</span>.dirtyHost = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.dirtyDimensions = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyScale || <span class="hljs-keyword">this</span>.dirtyDimensions || <span class="hljs-keyword">this</span>.dirtyStart || <span class="hljs-keyword">this</span>.dirtyOffset || <span class="hljs-keyword">this</span>.dirtyHandle) <span class="hljs-keyword">this</span>.dirtyPathObject = <span class="hljs-literal">true</span>;

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyRotation) <span class="hljs-keyword">this</span>.dirtyCollision = <span class="hljs-literal">true</span>;


        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyScale) <span class="hljs-keyword">this</span>.cleanScale();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyDimensions) <span class="hljs-keyword">this</span>.cleanDimensions();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyLock) <span class="hljs-keyword">this</span>.cleanLock();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyStart) <span class="hljs-keyword">this</span>.cleanStart();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyOffset) <span class="hljs-keyword">this</span>.cleanOffset();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyHandle) <span class="hljs-keyword">this</span>.cleanHandle();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyRotation) <span class="hljs-keyword">this</span>.cleanRotation();

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isBeingDragged || <span class="hljs-keyword">this</span>.lockTo.indexOf(<span class="hljs-string">'mouse'</span>) &gt;= <span class="hljs-number">0</span>) {

            <span class="hljs-keyword">this</span>.dirtyStampPositions = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">this</span>.dirtyStampHandlePositions = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyStampPositions) <span class="hljs-keyword">this</span>.cleanStampPositions();
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyStampHandlePositions) <span class="hljs-keyword">this</span>.cleanStampHandlePositions();

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyPathObject) {

            <span class="hljs-keyword">this</span>.cleanPathObject();
            <span class="hljs-keyword">this</span>.dirtyCollision = <span class="hljs-literal">true</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>update artefacts subscribed to this artefact (using it as their pivot or mimic source), if required</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyPositionSubscribers) <span class="hljs-keyword">this</span>.updatePositionSubscribers();</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Anchor housekeeping</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.anchor &amp;&amp; <span class="hljs-keyword">this</span>.dirtyAnchorHold) {

            <span class="hljs-keyword">this</span>.dirtyAnchorHold = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.buildAnchor(<span class="hljs-keyword">this</span>.anchor);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>EVERY ENTITY FILE will need to define its own .cleanPathObject function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.cleanPathObject = defaultNonReturnFunction;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.draw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        engine.stroke(<span class="hljs-keyword">this</span>.pathObject);
    };

    P.fill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        engine.fill(<span class="hljs-keyword">this</span>.pathObject, <span class="hljs-keyword">this</span>.winding);
    };

    P.drawAndFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> p = <span class="hljs-keyword">this</span>.pathObject;

        engine.stroke(p);
        <span class="hljs-keyword">this</span>.currentHost.clearShadow();
        engine.fill(p, <span class="hljs-keyword">this</span>.winding);
    };

    P.fillAndDraw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> p = <span class="hljs-keyword">this</span>.pathObject;

        engine.stroke(p);
        <span class="hljs-keyword">this</span>.currentHost.clearShadow();
        engine.fill(p, <span class="hljs-keyword">this</span>.winding);
        engine.stroke(p);
    };

    P.drawThenFill = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> p = <span class="hljs-keyword">this</span>.pathObject;

        engine.stroke(p);
        engine.fill(p, <span class="hljs-keyword">this</span>.winding);
    };

    P.fillThenDraw = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> p = <span class="hljs-keyword">this</span>.pathObject;

        engine.fill(p, <span class="hljs-keyword">this</span>.winding);
        engine.stroke(p);
    };

    P.clear = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{

        <span class="hljs-keyword">let</span> gco = engine.globalCompositeOperation;

        engine.globalCompositeOperation = <span class="hljs-string">'destination-out'</span>;
        engine.fill(<span class="hljs-keyword">this</span>.pathObject, <span class="hljs-keyword">this</span>.winding);
        
        engine.globalCompositeOperation = gco;
    };

    P.none = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">engine</span>) </span>{}</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.stamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">force = false, host, changes</span>) </span>{

        <span class="hljs-keyword">let</span> filterTest = (!<span class="hljs-keyword">this</span>.noFilters &amp;&amp; <span class="hljs-keyword">this</span>.filters &amp;&amp; <span class="hljs-keyword">this</span>.filters.length) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (force) {

            <span class="hljs-keyword">if</span> (host &amp;&amp; host.type === <span class="hljs-string">'Cell'</span>) <span class="hljs-keyword">this</span>.currentHost = host;

            <span class="hljs-keyword">if</span> (changes) {

                <span class="hljs-keyword">this</span>.set(changes);
                <span class="hljs-keyword">this</span>.prepareStamp();
            }

            <span class="hljs-keyword">if</span> (filterTest) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.filteredStamp();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.regularStamp();
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.visibility) {

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.stashOutput || filterTest) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.filteredStamp();
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.regularStamp();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(<span class="hljs-literal">false</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.filteredStamp = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Clean and sort the Entity-level filters before sending them to the filter worker for application</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dirtyFilters || !<span class="hljs-keyword">this</span>.currentFilters) <span class="hljs-keyword">this</span>.cleanFilters();

        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>An internal cleanup function to release resources and restore the non-filter defaults to what they were before. It’s also in the cleanup phase that we (finally) copy over the results of the filter over to the current canvas display, taking into account the entity’s composite and alpha values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> cleanup = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                <span class="hljs-keyword">if</span> (worker) releaseFilterWorker(worker);

                currentEngine.save();
                
                currentEngine.globalCompositeOperation = self.filterComposite;
                currentEngine.globalAlpha = self.filterAlpha;
                currentEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

                currentEngine.drawImage(filterElement, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>This is also the point at which we action any requests to stash the Cell output and (optionally) create/update imageAsset objects and associated &lt;img&gt; elements for use elsewhere in the Scrawl-canvas ecosystem.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (self.stashOutput) {

                    self.stashOutput = <span class="hljs-literal">false</span>;

                    <span class="hljs-keyword">let</span> [stashX, stashY, stashWidth, stashHeight] = self.getCellCoverage(filterEngine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, filterElement.width, filterElement.height));

                    self.stashedImageData = filterEngine.getImageData(stashX, stashY, stashWidth, stashHeight);

                    <span class="hljs-keyword">if</span> (self.stashOutputAsAsset) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>KNOWN ISSUE - it takes time for the images to load the new dataURLs generated from canvas elements. See demo canvas-020 for a setTimeout-based workaround.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        self.stashOutputAsAsset = <span class="hljs-literal">false</span>;

                        filterElement.width = stashWidth;
                        filterElement.height = stashHeight;
                        filterEngine.putImageData(self.stashedImageData, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

                        <span class="hljs-keyword">if</span> (!self.stashedImage) {

                            <span class="hljs-keyword">let</span> newimg = self.stashedImage = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'img'</span>);

                            newimg.id = <span class="hljs-string">`<span class="hljs-subst">${self.name}</span>-image`</span>;

                            newimg.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

                                scrawlCanvasHold.appendChild(newimg);
                                importDomImage(<span class="hljs-string">`#<span class="hljs-subst">${newimg.id}</span>`</span>);
                            };

                            newimg.src = filterElement.toDataURL();
                        }
                        <span class="hljs-keyword">else</span> self.stashedImage.src = filterElement.toDataURL();
                    }
                }
        
                releaseCell(filterHost);

                currentEngine.restore();

                self.currentHost = currentHost;
                self.noCanvasEngineUpdates = oldNoCanvasEngineUpdates;
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>save current host data into a set of vars, ready for restoration after web worker completes or fails</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> currentHost = self.currentHost,
                currentElement = currentHost.element,
                currentEngine = currentHost.engine,
                currentDimensions = currentHost.currentDimensions;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>get and prepare a blank canvas for the filter operations</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> filterHost = requestCell(),
                filterElement = filterHost.element,
                filterEngine = filterHost.engine;

            self.currentHost = filterHost;
            
            <span class="hljs-keyword">let</span> w = filterElement.width = currentDimensions[<span class="hljs-number">0</span>] || currentElement.width,
                h = filterElement.height = currentDimensions[<span class="hljs-number">1</span>] || currentElement.height;</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Switch off fast stamp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> oldNoCanvasEngineUpdates = self.noCanvasEngineUpdates;
            self.noCanvasEngineUpdates = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>stamp the entity onto the blank canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            self.regularStampSynchronousActions();</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>At this point we will send the contents of the host canvas over to the web worker, alongside details of the filters we wish to apply to it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">let</span> worker, myimage;

            <span class="hljs-keyword">if</span> (!self.noFilters &amp;&amp; self.filters &amp;&amp; self.filters.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>if we’re using the entity as a stencil, copy the entity cell’s current display over the entity in the blank canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (self.isStencil) {

                    filterEngine.save();
                    filterEngine.globalCompositeOperation = <span class="hljs-string">'source-in'</span>;
                    filterEngine.globalAlpha = <span class="hljs-number">1</span>;
                    filterEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                    filterEngine.drawImage(currentElement, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                    filterEngine.restore();
                } 

                filterEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

                myimage = filterEngine.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h);
                worker = requestFilterWorker();

                actionFilterWorker(worker, {
                    <span class="hljs-attr">image</span>: myimage,
                    <span class="hljs-attr">filters</span>: self.currentFilters
                })
                .then(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>handle the web worker response</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">if</span> (img) {

                        filterEngine.globalCompositeOperation = <span class="hljs-string">'source-over'</span>;
                        filterEngine.globalAlpha = <span class="hljs-number">1</span>;
                        filterEngine.setTransform(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                        filterEngine.putImageData(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

                        cleanup();
                        resolve(<span class="hljs-literal">true</span>);
                    }
                    <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'image issue'</span>);
                })
                .catch(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {

                    cleanup();
                    reject(<span class="hljs-literal">false</span>);
                });
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Where no filter is required, but we still want to stash the results</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">else</span> {

                cleanup();
                resolve(<span class="hljs-literal">true</span>);
            }
        });
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.getCellCoverage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">img</span>) </span>{

        <span class="hljs-keyword">let</span> width = img.width,
            height = img.height,
            data = img.data,
            maxX = <span class="hljs-number">0</span>,
            maxY = <span class="hljs-number">0</span>,
            minX = width,
            minY = height,
            counter = <span class="hljs-number">3</span>,
            x, y;

        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>; y &lt; height; y++) {

            <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>; x &lt; width; x++) {

                <span class="hljs-keyword">if</span> (data[counter]) {

                    <span class="hljs-keyword">if</span> (minX &gt; x) minX = x;
                    <span class="hljs-keyword">if</span> (maxX &lt; x) maxX = x;
                    <span class="hljs-keyword">if</span> (minY &gt; y) minY = y;
                    <span class="hljs-keyword">if</span> (maxY &lt; y) maxY = y;
                }

                counter += <span class="hljs-number">4</span>;
            }
        }
        <span class="hljs-keyword">if</span> (minX &lt; maxX &amp;&amp; minY &lt; maxY) <span class="hljs-keyword">return</span> [minX, minY, maxX - minX, maxY - minY];
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height];
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>TODO - documentation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    P.regularStamp = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {

            <span class="hljs-keyword">if</span> (self.currentHost) {

                self.regularStampSynchronousActions();
                resolve(<span class="hljs-literal">true</span>);
            }
            reject(<span class="hljs-literal">false</span>);
        });
    };

    P.regularStampSynchronousActions = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{

        <span class="hljs-keyword">let</span> dest = <span class="hljs-keyword">this</span>.currentHost;

        <span class="hljs-keyword">if</span> (dest) {

            <span class="hljs-keyword">let</span> engine = dest.engine,
                stamp = <span class="hljs-keyword">this</span>.currentStampPosition,
                x = stamp[<span class="hljs-number">0</span>],
                y = stamp[<span class="hljs-number">1</span>];

            dest.rotateDestination(engine, x, y, <span class="hljs-keyword">this</span>);

            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.noCanvasEngineUpdates) dest.setEngine(<span class="hljs-keyword">this</span>);

            <span class="hljs-keyword">this</span>[<span class="hljs-keyword">this</span>.method](engine);
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Return the prototype</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> P;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
